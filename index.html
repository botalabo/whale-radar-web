<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Botalab Whale Radar v4.1 - Anti-Spoofing WEB EDITION</title>
<style>
  /* ============================================
     Cyberpunk Palette â€” whale_radar_gui.py å®Œå…¨æº–æ‹ 
     ============================================ */
  :root {
    --neon-green:  #00FF41;
    --neon-cyan:   #00E5FF;
    --neon-red:    #FF0040;
    --neon-yellow: #FFE600;
    --neon-orange: #FF8800;
    --neon-pink:   #FF2D6A;
    --dark-bg:     #0A0A0F;
    --panel-bg:    #111118;
    --card-bg:     #1A1A25;
    --dim-text:    #556677;
    --white-text:  #E0E0E0;
    --price-up:    #00FF41;
    --price-down:  #FF0040;
    --price-flat:  #888888;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark-bg);
    color: var(--white-text);
    font-family: 'Consolas', 'Courier New', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Grid overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      linear-gradient(rgba(0,229,255,.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,.025) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none; z-index: 0;
  }
  /* Scanlines */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(
      0deg, transparent, transparent 2px,
      rgba(0,0,0,.035) 2px, rgba(0,0,0,.035) 4px);
    pointer-events: none; z-index: 9999;
  }

  /* ============================================ MARQUEE */
  .marquee-row {
    position: relative; z-index: 1;
    height: 36px; overflow: hidden;
    display: flex; align-items: center;
    flex-shrink: 0;
  }
  .marquee-row-1 { background: #000000; }
  .marquee-row-2 { background: #000000; transition: background 0.3s; }

  .marquee-track {
    display: inline-block; white-space: nowrap;
    animation: mq-scroll 45s linear infinite;
    font-family: 'Consolas', monospace;
    font-size: 13px; font-weight: bold;
    padding-left: 100%;
  }
  .marquee-row-1 .marquee-track { color: #FFFF00; }
  .marquee-row-2 .marquee-track { color: #FFA500; }
  @keyframes mq-scroll {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }

  /* ============================================ HEADER (70px) */
  .header {
    position: relative; z-index: 1;
    display: flex; align-items: center;
    background: var(--panel-bg);
    height: 70px; min-height: 70px;
    padding: 0 15px; flex-shrink: 0;
  }
  .header-title {
    font-size: 22px; font-weight: bold;
    color: var(--neon-green);
    text-shadow: 0 0 20px rgba(0,255,65,.4);
    letter-spacing: 3px; white-space: nowrap;
  }
  .live-label {
    font-size: 14px; font-weight: bold;
    margin-left: 10px; white-space: nowrap;
  }
  .header-sub {
    font-size: 10px; color: var(--dim-text);
    margin-left: 10px; white-space: nowrap;
  }
  .header-right {
    margin-left: auto; display: flex;
    align-items: center; gap: 10px;
  }
  .header-clock {
    font-size: 14px; color: var(--neon-cyan);
    text-shadow: 0 0 8px rgba(0,229,255,.3);
    white-space: nowrap;
  }

  /* ============================================ MAIN 2-COLUMN */
  .main-area {
    position: relative; z-index: 1;
    display: flex; flex: 1;
    overflow: hidden;
    padding: 5px 10px; gap: 10px;
    min-height: 0;
  }

  /* ============================================ LEFT PANEL (310px) */
  .left-panel {
    width: 310px; min-width: 310px;
    background: var(--panel-bg);
    border: 1px solid #1E1E2E;
    border-radius: 8px;
    display: flex; flex-direction: column;
    overflow: hidden; flex-shrink: 0;
  }

  /* Status indicator */
  .status-ind {
    text-align: center; font-size: 11px;
    font-weight: bold; padding: 8px 0 4px;
  }
  .status-ind.on  { color: var(--neon-green); }
  .status-ind.off { color: var(--dim-text); }

  /* Progress */
  .progress-box {
    margin: 0 10px 4px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px; padding: 4px 8px;
  }
  .progress-row {
    display: flex; align-items: center;
    justify-content: center; gap: 5px;
    font-size: 11px; font-weight: bold;
    color: var(--neon-cyan); padding: 2px 0;
  }
  .progress-row .sp { display: inline-block; width: 16px; text-align: center; }
  .pbar-wrap {
    background: #1A1A25; border-radius: 3px;
    height: 10px; overflow: hidden;
  }
  .pbar-fill {
    height: 100%; background: var(--neon-green);
    border-radius: 3px; width: 0%;
    transition: width 0.6s ease;
  }
  .pbar-pct {
    text-align: center; font-size: 9px;
    color: var(--dim-text); padding: 2px 0;
  }

  /* Price header */
  .price-hdr {
    text-align: center; font-size: 10px;
    color: var(--dim-text); padding: 4px 0 2px;
  }

  /* Price grid (scrollable) */
  .price-grid-wrap {
    flex: 1; margin: 0 10px; min-height: 0;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 6px;
    overflow-y: auto; padding: 4px;
  }
  .price-grid-wrap::-webkit-scrollbar { width: 4px; }
  .price-grid-wrap::-webkit-scrollbar-track { background: transparent; }
  .price-grid-wrap::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .price-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
  }
  .price-cell {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 3px 6px; border-radius: 3px;
    background: rgba(0,0,0,.15);
  }
  .price-cell:hover { background: rgba(0,229,255,.04); }
  .price-sym {
    font-size: 11px; font-weight: bold;
    color: var(--neon-green); cursor: default;
  }
  .price-val {
    font-size: 10px; text-align: right; white-space: nowrap;
    color: var(--dim-text);
  }

  /* Action panel / summary */
  .action-box {
    margin: 4px 10px 6px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px; padding: 5px 8px;
  }
  .action-hdr {
    text-align: center; font-size: 9px;
    color: var(--dim-text); padding: 0 0 3px;
  }
  .sum-row {
    display: flex; justify-content: space-between;
    font-size: 10px; padding: 1px 0;
  }
  .sum-lbl { color: var(--dim-text); }
  .sum-val { font-weight: bold; }
  .sum-val.v-whale   { color: var(--neon-green); }
  .sum-val.v-spoof   { color: var(--neon-yellow); }
  .sum-val.v-insider  { color: var(--neon-pink); }
  .sum-val.v-total   { color: var(--neon-cyan); }

  .scan-info {
    margin: 2px 10px 6px;
    text-align: center; font-size: 9px;
    color: var(--dim-text);
  }
  .scan-info .cy { color: var(--neon-cyan); }

  /* ============================================ RIGHT PANEL */
  .right-panel {
    flex: 1; min-width: 0;
    background: var(--panel-bg);
    border: 1px solid #1E1E2E;
    border-radius: 8px;
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  /* Section wrappers */
  .pred-section {
    flex: 2; display: flex; flex-direction: column;
    padding: 8px 8px 4px; min-height: 0;
  }
  .alert-section {
    flex: 3; display: flex; flex-direction: column;
    padding: 4px 8px 8px; min-height: 0;
  }

  .sec-title {
    font-size: 13px; font-weight: bold;
    padding-bottom: 4px; white-space: nowrap;
    flex-shrink: 0;
  }
  .sec-title.green { color: var(--neon-green); }
  .sec-title.red   { color: var(--neon-red); }

  /* Log textbox */
  .logbox {
    flex: 1; min-height: 0;
    border-radius: 4px;
    border: 1px solid;
    overflow-y: auto;
    padding: 6px 8px;
    font-size: 14px;
    line-height: 1.55;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .logbox::-webkit-scrollbar { width: 5px; }
  .logbox::-webkit-scrollbar-track { background: transparent; }
  .logbox::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  .logbox.pred {
    background: #080D06; border-color: #1E2E1E;
    color: var(--white-text);
  }
  .logbox.hist {
    background: #0D0006; border-color: #2A0015;
    color: var(--white-text);
  }

  /* Log lines */
  .ll { padding: 1px 0; border-bottom: 1px solid rgba(255,255,255,.015); }
  .ll .ts { color: var(--dim-text); font-size: 12px; }

  /* Color classes (matching desktop tags) */
  .c-dim    { color: var(--dim-text); }
  .c-green  { color: var(--neon-green); }
  .c-cyan   { color: var(--neon-cyan); }
  .c-red    { color: var(--neon-red); }
  .c-yellow { color: var(--neon-yellow); }
  .c-orange { color: var(--neon-orange); }
  .c-pink   { color: var(--neon-pink); }
  .c-white  { color: var(--white-text); }

  /* Bold variants (desktop: font size 18 bold â†’ web: 15px bold) */
  .b-red    { color: var(--neon-red); font-weight: bold; font-size: 15px; }
  .b-green  { color: var(--neon-green); font-weight: bold; font-size: 15px; }
  .b-cyan   { color: var(--neon-cyan); font-weight: bold; font-size: 15px; }
  .b-yellow { color: var(--neon-yellow); font-weight: bold; font-size: 15px; }
  .b-orange { color: var(--neon-orange); font-weight: bold; font-size: 15px; }
  .b-fire   { color: var(--neon-orange); font-weight: bold; font-size: 15px;
              background: #331500; padding: 0 3px; border-radius: 2px; }

  /* Disclaimer */
  .disclaimer {
    flex-shrink: 0; margin-top: 4px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px; padding: 4px 8px;
    font-size: 10px; color: var(--dim-text);
    line-height: 1.4;
  }

  /* ============================================ STATUS BAR (30px) */
  .status-bar {
    position: relative; z-index: 1;
    display: flex; align-items: center;
    justify-content: space-between;
    background: var(--panel-bg);
    height: 30px; min-height: 30px;
    padding: 0 10px; font-size: 11px;
    flex-shrink: 0;
  }
  .sb-left  { color: var(--dim-text); }
  .sb-right { color: #333344; }

  /* ============================================ GATE OVERLAY */
  .gate-overlay {
    position: fixed; inset: 0;
    z-index: 10000;
    background: rgba(10,10,15,.97);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.6s ease;
  }
  .gate-overlay.show {
    opacity: 1; pointer-events: auto;
  }

  .gate-box {
    background: var(--panel-bg);
    border: 2px solid var(--neon-cyan);
    border-radius: 16px;
    padding: 36px 40px;
    width: 480px; max-width: 92vw;
    text-align: center;
    box-shadow: 0 0 60px rgba(0,229,255,.15);
  }
  .gate-box .logo { font-size: 52px; margin-bottom: 8px; }
  .gate-box h2 {
    font-size: 20px; font-weight: bold;
    color: var(--neon-green);
    text-shadow: 0 0 16px rgba(0,255,65,.4);
    letter-spacing: 2px; margin-bottom: 4px;
  }
  .gate-box .edition {
    font-size: 11px; color: var(--dim-text);
    margin-bottom: 20px;
  }

  /* note èª˜å° */
  .gate-promo {
    background: #1A1400;
    border: 1px solid rgba(255,230,0,.25);
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 20px;
    text-align: left; line-height: 1.6;
  }
  .gate-promo .promo-title {
    font-size: 14px; font-weight: bold;
    color: var(--neon-yellow);
    margin-bottom: 6px;
  }
  .gate-promo .promo-body {
    font-size: 12px; color: var(--white-text);
  }
  .gate-promo .promo-body .dim { color: var(--dim-text); }
  .gate-promo a {
    color: var(--neon-cyan);
    text-decoration: none;
    font-weight: bold;
  }
  .gate-promo a:hover {
    text-decoration: underline;
    text-shadow: 0 0 8px rgba(0,229,255,.4);
  }
  .gate-promo .member-badge {
    display: inline-block;
    background: rgba(0,255,65,.12);
    border: 1px solid var(--neon-green);
    color: var(--neon-green);
    font-size: 11px; font-weight: bold;
    padding: 2px 10px; border-radius: 4px;
    margin-top: 8px;
  }

  /* countdown */
  .gate-countdown {
    font-size: 11px; color: var(--dim-text);
    margin-bottom: 14px;
  }
  .gate-countdown .sec { color: var(--neon-orange); font-weight: bold; }

  /* input */
  .gate-box input {
    width: 100%; padding: 12px 16px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 6px;
    color: var(--white-text);
    font-family: 'Consolas', monospace;
    font-size: 14px; outline: none;
    margin-bottom: 12px; text-align: center;
  }
  .gate-box input:focus {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 8px rgba(0,229,255,.2);
  }
  .gate-box input::placeholder { color: #444; }
  .gate-box button {
    width: 100%; padding: 12px;
    background: #002200;
    border: 2px solid var(--neon-green);
    border-radius: 6px;
    color: var(--neon-green);
    font-family: 'Consolas', monospace;
    font-size: 15px; font-weight: bold;
    cursor: pointer; transition: background .2s;
  }
  .gate-box button:hover { background: #003300; }
  .gate-error {
    color: var(--neon-red);
    font-size: 12px;
    margin-top: 10px; min-height: 18px;
  }

  /* ============================================ RESPONSIVE */
  @media (max-width: 900px) {
    .main-area { flex-direction: column; }
    .left-panel { width: 100%; min-width: 100%; max-height: 260px; }
    .price-grid { grid-template-columns: 1fr 1fr 1fr; }
    .header-sub { display: none; }
    .header-title { font-size: 16px; letter-spacing: 1px; }
  }
</style>
</head>
<body>

<!-- ======== MARQUEE 1 (Yellow â€” å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) ======== -->
<div class="marquee-row marquee-row-1">
  <div class="marquee-track" id="mq1">&#x26A0;&#xFE0F; ç•°å¸¸æ¿ã‚’æ¤œçŸ¥ä¸­ï¼šå·¨å¤§ãªå£ï¼ˆæ¿ï¼‰ã¯ã‚¯ã‚¸ãƒ©ã®ç‰½åˆ¶ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å®‰æ˜“ãªé£›ã³ã¤ãã«æ³¨æ„ã€‚ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#x26A0;&#xFE0F; ç•°å¸¸æ¿ã‚’æ¤œçŸ¥ä¸­ï¼šå·¨å¤§ãªå£ï¼ˆæ¿ï¼‰ã¯ã‚¯ã‚¸ãƒ©ã®ç‰½åˆ¶ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å®‰æ˜“ãªé£›ã³ã¤ãã«æ³¨æ„ã€‚</div>
</div>

<!-- ======== MARQUEE 2 (Orange â€” ã‚¢ãƒ©ãƒ¼ãƒˆé€Ÿå ±) ======== -->
<div class="marquee-row marquee-row-2" id="mqRow2">
  <div class="marquee-track" id="mq2">&#x23F3; ã‚¢ãƒ©ãƒ¼ãƒˆå¾…æ©Ÿä¸­...</div>
</div>

<!-- ======== GATE OVERLAY (1åˆ†å¾Œã«è¡¨ç¤º) ======== -->
<div class="gate-overlay" id="gateOverlay">
  <div class="gate-box">
    <div class="logo">&#x1F40B;</div>
    <h2>BOTALAB WHALE RADAR</h2>
    <div class="edition">Anti-Spoofing WEB EDITION</div>

    <div class="gate-promo">
      <div class="promo-title">&#x1F525; ãƒœã‚¿ãƒ©ãƒœ note ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—</div>
      <div class="promo-body">
        ã‚¯ã‚¸ãƒ©ãƒ»ç•°å¸¸æ¿ãƒ»ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ã®æ¤œçŸ¥ãƒ‡ãƒ¼ã‚¿ã‚’<br>
        24æ™‚é–“ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é–²è¦§ã§ãã¾ã™ã€‚<br>
        å¤§å£ã®å‹•å‘ã®è©³ç´°è§£èª¬ã‚„éŠ˜æŸ„åˆ†æã‚‚é…ä¿¡ä¸­ã€‚<br><br>
        &#x1F449; <a href="https://note.com/bota_labo_note/n/n12cd6b0d2eb2" target="_blank" rel="noopener">ãƒœã‚¿ãƒ©ãƒœ note ã‚’è¦‹ã‚‹</a><br>
        <span class="dim">ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ä¼šå“¡ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã„ã¤ã§ã‚‚é–²è¦§å¯èƒ½ã§ã™ã€‚</span><br>
        <span class="member-badge">&#x2705; ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ä¼šå“¡ â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã§å¸¸æ™‚é–²è¦§OK</span>
      </div>
    </div>

    <div class="gate-countdown" id="gateCountdown"></div>

    <input type="password" id="gatePass" placeholder="&#x1F512; ãƒ¡ãƒ³ãƒãƒ¼é™å®šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
    <button onclick="doGateLogin()">&#x25B6;&ensp;ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div class="gate-error" id="gateErr"></div>
  </div>
</div>

<!-- ======== HEADER ======== -->
<div class="header">
  <span class="header-title">&#x1F40B;&ensp;BOTALAB&ensp;WHALE&ensp;RADAR&ensp;v4.1</span>
  <span class="live-label" id="liveLabel">&#x25CF; LIVE</span>
  <span class="header-sub">WEB EDITION</span>
  <div class="header-right">
    <span class="header-clock" id="clock">&#x1F550; ----/--/-- --:--:--</span>
  </div>
</div>

<!-- ======== MAIN AREA ======== -->
<div class="main-area">

  <!-- ===== LEFT PANEL (310px) ===== -->
  <div class="left-panel">

    <!-- ONLINE / OFFLINE -->
    <div class="status-ind off" id="statusInd">&#x25CF; OFFLINE</div>

    <!-- Progress -->
    <div class="progress-box">
      <div class="progress-row">
        <span class="sp" id="spinner"></span>
        <span id="progText">å¾…æ©Ÿä¸­...</span>
      </div>
      <div class="pbar-wrap"><div class="pbar-fill" id="pbar"></div></div>
      <div class="pbar-pct" id="pbarPct">0 %</div>
    </div>

    <!-- Price header -->
    <div class="price-hdr" id="priceHdr">â”€â”€ LIVE PRICES (0) â”€â”€</div>

    <!-- Price grid -->
    <div class="price-grid-wrap">
      <div class="price-grid" id="priceGrid"></div>
    </div>

    <!-- Summary -->
    <div class="action-box">
      <div class="action-hdr">â”€ ALERT SUMMARY â”€</div>
      <div class="sum-row"><span class="sum-lbl">&#x1F6A8; å¤§å£ã‚ªãƒ—ã‚·ãƒ§ãƒ³</span><span class="sum-val v-whale" id="sWhale">0</span></div>
      <div class="sum-row"><span class="sum-lbl">&#x26A0;&#xFE0F; ç•°å¸¸æ¿ï¼ˆå£ï¼‰</span><span class="sum-val v-spoof" id="sSpoof">0</span></div>
      <div class="sum-row"><span class="sum-lbl">&#x1F575;&#xFE0F; ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼</span><span class="sum-val v-insider" id="sInsider">0</span></div>
      <div class="sum-row" style="border-top:1px solid #2A2A3A;margin-top:2px;padding-top:3px;">
        <span class="sum-lbl">åˆè¨ˆ</span><span class="sum-val v-total" id="sTotal">0</span>
      </div>
    </div>

    <!-- Scan info -->
    <div class="scan-info">
      SCANS: <span class="cy" id="scanCnt">0</span> &nbsp;|&nbsp;
      ALERTS: <span class="cy" id="alertCnt">0</span>
    </div>
  </div>

  <!-- ===== RIGHT PANEL ===== -->
  <div class="right-panel">

    <!-- äºˆæ¸¬ãƒ»åˆ¤å®šå±¥æ­´ -->
    <div class="pred-section">
      <div class="sec-title green">&ensp;&#x1F3AF;&ensp;ã‚¯ã‚¸ãƒ©ã®äºˆæ¸¬ãƒ»åˆ¤å®šå±¥æ­´ (PREDICTION RECORD)</div>
      <div class="logbox pred" id="predBox"></div>
    </div>

    <!-- WHALE ALERT å±¥æ­´ -->
    <div class="alert-section">
      <div class="sec-title red">&ensp;&#x1F6A8;&ensp;WHALE ALERT å±¥æ­´</div>
      <div class="logbox hist" id="alertBox"></div>

      <div class="disclaimer">
        &#x26A0;&#xFE0F; ç•°å¸¸æ¿ï¼šå¿…ãšã—ã‚‚ãƒ•ã‚§ã‚¤ã‚¯ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚å¤§å£ã®å®Ÿéœ€ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã€æ¿ã®åšã¿ã®å¤‰åŒ–ã‚’ç¤ºã™æŒ‡æ¨™ã§ã™ã€‚<br>
        åˆ¤å®šåŸºæº–ï¼šå„ä¾¡æ ¼å¸¯ã®æ³¨æ–‡ã‚µã‚¤ã‚ºã‚’éŠ˜æŸ„ã”ã¨ã®å¹³å‡çš„ãªæ¿ã®åšã¿ã¨æ¯”è¼ƒã—ã€10å€ä»¥ä¸Šã®ç•°å¸¸ã‚µã‚¤ã‚ºã‚’æ¤œçŸ¥ã—ã¦ã„ã¾ã™ã€‚
      </div>
    </div>

  </div>
</div>

<!-- ======== STATUS BAR ======== -->
<div class="status-bar">
  <span class="sb-left" id="sbLeft">&ensp;Ready.&ensp;|&ensp;Rate-Limit: ON</span>
  <span class="sb-right">Botalab Whale Radar v4.1 Anti-Spoofing WEB&ensp;</span>
</div>

<script>
/* ============================================================
   Whale Radar v4.1 â€” WEB EDITION
   Desktop GUI å®Œå…¨å†ç¾
   ============================================================ */
const API = window.location.origin;
const POLL_MS = 8000;   // 8ç§’ãƒãƒ¼ãƒªãƒ³ã‚°

/* ---------- Gate (1åˆ†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰) ---------- */
let gateUnlocked = false;
const GATE_DELAY_SEC = 60;  // 1åˆ†å¾Œã«ã‚²ãƒ¼ãƒˆè¡¨ç¤º
let gateTimer = null;

/* ---------- Spinner (desktop ã¨åŒã˜ Braille) ---------- */
const SP = ['\u28CB','\u2819','\u2839','\u2838','\u283C','\u2834','\u2826','\u2827','\u2807','\u280F'];
let spIdx = 0;

/* ---------- LIVE pulse ---------- */
let pulseStep = 0;

/* ---------- Yoyo scroll state ---------- */
const YOYO_INTERVAL = 1000;
const YOYO_PAUSE    = 4.0;
const YOYO_SNAP     = 4.0;
const yoyoState = {};

/* ---------- Prediction tracking (client-side) ---------- */
const predictions = {};   // { ticker: { direction, price, time } }
let lastScanCount = -1;
let watchlistBuilt = false;
let totalAlertCount = 0;

/* ============================================================
   Clock â€” ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¨åŒã˜ ğŸ• YYYY-MM-DD HH:MM:SS å½¢å¼
   ============================================================ */
function updateClock() {
  const d = new Date();
  const Y = d.getFullYear();
  const M = String(d.getMonth()+1).padStart(2,'0');
  const D = String(d.getDate()).padStart(2,'0');
  const h = String(d.getHours()).padStart(2,'0');
  const m = String(d.getMinutes()).padStart(2,'0');
  const s = String(d.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `\u{1F550} ${Y}-${M}-${D}  ${h}:${m}:${s}`;
}

/* ============================================================
   LIVE pulse (sin-wave #FF0040 â†” #550018)
   ============================================================ */
function animatePulse() {
  pulseStep++;
  const b = (Math.sin(pulseStep * 0.15) + 1) / 2;
  const r = Math.round(0x55 + (0xFF - 0x55) * b);
  const g = 0;
  const bl = Math.round(0x18 + (0x40 - 0x18) * b);
  const c = '#' + r.toString(16).padStart(2,'0') + '00' + bl.toString(16).padStart(2,'0');
  const el = document.getElementById('liveLabel');
  el.style.color = c;
  el.style.textShadow = `0 0 ${Math.round(10*b)}px ${c}`;
}

/* ============================================================
   Spinner
   ============================================================ */
function tickSpinner(scanning) {
  const el = document.getElementById('spinner');
  if (scanning) {
    spIdx = (spIdx + 1) % SP.length;
    el.textContent = SP[spIdx];
  } else {
    el.textContent = '';
  }
}

/* ============================================================
   Yoyo auto-scroll
   ============================================================ */
function getYoyo(id) {
  if (!yoyoState[id]) yoyoState[id] = { dir: 1, pauseUntil: 0, snapUntil: 0 };
  return yoyoState[id];
}
function yoyoSnap(id) {
  const s = getYoyo(id);
  s.snapUntil = Date.now() / 1000 + YOYO_SNAP;
  s.dir = -1;
  const el = document.getElementById(id);
  if (el) el.scrollTop = el.scrollHeight;
}
function yoyoTick(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const s = getYoyo(id);
  const now = Date.now() / 1000;

  if (now < s.snapUntil) { el.scrollTop = el.scrollHeight; return; }
  if (now < s.pauseUntil) return;

  const atTop = el.scrollTop <= 0;
  const atBot = el.scrollTop + el.clientHeight >= el.scrollHeight - 2;

  if (s.dir === 1) {
    if (atBot) { s.pauseUntil = now + YOYO_PAUSE; s.dir = -1; }
    else el.scrollTop += 20;
  } else {
    if (atTop) { s.pauseUntil = now + YOYO_PAUSE; s.dir = 1; }
    else el.scrollTop -= 20;
  }
}

/* ============================================================
   Build price grid
   ============================================================ */
function buildPrices(list) {
  const g = document.getElementById('priceGrid');
  g.innerHTML = '';
  for (const sym of list) {
    const c = document.createElement('div');
    c.className = 'price-cell';
    c.innerHTML = '<span class="price-sym">' + sym + '</span><span class="price-val" id="P_' + sym + '">---</span>';
    g.appendChild(c);
  }
  document.getElementById('priceHdr').textContent = '\u2500\u2500 LIVE PRICES (' + list.length + ') \u2500\u2500';
}

/* ============================================================
   Update price labels
   ============================================================ */
function updatePrices(tickers) {
  for (const [sym, info] of Object.entries(tickers)) {
    const el = document.getElementById('P_' + sym);
    if (!el) continue;
    if (info.price) {
      const p = info.price.price;
      const ch = info.price.change;
      const pct = info.price.change_pct;
      const sign = ch >= 0 ? '+' : '';
      el.style.color = ch > 0 ? 'var(--price-up)' : ch < 0 ? 'var(--price-down)' : 'var(--price-flat)';
      el.textContent = '$' + p.toFixed(2) + ' ' + sign + pct.toFixed(1) + '%';
    } else {
      el.style.color = 'var(--dim-text)';
      el.textContent = '---';
    }
  }
}

/* ============================================================
   HTML escape
   ============================================================ */
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ============================================================
   Log line helpers (match desktop format)
   ============================================================ */
function logLine(ts, text, cls) {
  return '<div class="ll"><span class="ts">[' + esc(ts) + '] </span><span class="' + cls + '">' + esc(text) + '</span></div>';
}

function nowTS() {
  const d = new Date();
  return String(d.getHours()).padStart(2,'0') + ':' +
         String(d.getMinutes()).padStart(2,'0') + ':' +
         String(d.getSeconds()).padStart(2,'0');
}

/* ============================================================
   Direction label (desktop _get_direction_label)
   ============================================================ */
function dirLabel(optType, ratio) {
  const extreme = ratio >= 10 || ratio >= 999;
  if (optType === 'CALL') return extreme ? '\u{1F4C8} å¼·ã„ä¸Šæ–¹ã‚·ã‚°ãƒŠãƒ«(CALL)' : '\u{1F4C8} ä¸Šæ–¹ã‚·ã‚°ãƒŠãƒ«(CALL)';
  return extreme ? '\u{1F4C9} å¼·ã„ä¸‹æ–¹ã‚·ã‚°ãƒŠãƒ«(PUT)' : '\u{1F4C9} ä¸‹æ–¹ã‚·ã‚°ãƒŠãƒ«(PUT)';
}

/* ============================================================
   Advice text (desktop get_advice_text)
   ============================================================ */
function adviceText(a) {
  if (a.type === 'SPOOFING_WALL') {
    if (a.option_type === 'PUT' || a.wall_side === 'BID')
      return '\u{1F449}ã€æˆ¦ç•¥ã€‘ä¸‹æ”¯ãˆã€ã¾ãŸã¯æ€¥è½ã‚’èª˜ã†ç½ ã€‚å£ã®ãƒ–ãƒ¬ã‚¤ã‚¯ãƒ€ã‚¦ãƒ³ï¼ˆä¸‹æŠœã‘ï¼‰ã«è­¦æˆ’ã—ã€é€†æŒ‡å€¤ã‚’å¾¹åº•ã€‚';
    return '\u{1F449}ã€æˆ¦ç•¥ã€‘ä¸Šå€¤ã‚’æŠ‘ãˆã‚‹åœ§åŠ›ã€ã¾ãŸã¯è¸ã¿ä¸Šã’ã®ç½ ã€‚å£ã®çªç ´ï¼ˆä¸ŠæŠœã‘ï¼‰æ™‚ã®æ€¥é¨°ã«è­¦æˆ’ã€‚';
  }
  if (a.type === 'WHALE_OPTIONS') {
    if (a.option_type === 'CALL')
      return '\u{1F449}ã€æˆ¦ç•¥ã€‘å¼·ã„ä¸Šæ˜‡ã‚·ã‚°ãƒŠãƒ«ã€‚ã‚¯ã‚¸ãƒ©ã®è³‡é‡‘æµå…¥ã«è¿½å¾“ï¼ˆé †å¼µã‚Šï¼‰ã‚’æ¤œè¨ã€‚';
    return '\u{1F449}ã€æˆ¦ç•¥ã€‘å¼·ã„ä¸‹è½ã‚·ã‚°ãƒŠãƒ«ã€‚ä¸‹æŠ¼ã—åœ§åŠ›ã«è­¦æˆ’ã—ã€ãƒ­ãƒ³ã‚°ãƒã‚¸ã‚·ãƒ§ãƒ³ã®åˆ©ç¢ºãƒ»ãƒ˜ãƒƒã‚¸ã‚’æ¤œè¨ã€‚';
  }
  if (a.type === 'INSIDER_BUY')
    return '\u{1F449}ã€æˆ¦ç•¥ã€‘å†…éƒ¨è€…ã®è‡ªç¤¾æ ªè³¼å…¥ã¯ä¸­é•·æœŸã®å¼·æ°—ã‚µã‚¤ãƒ³ã€‚æ±ºç®—æ—¥ç¨‹ã¨åˆã‚ã›ã¦ç¢ºèªã‚’ã€‚';
  return '';
}

/* ============================================================
   Wall commentary (desktop _get_wall_commentary)
   ============================================================ */
function wallCommentary(a, curPrice) {
  if (!curPrice || curPrice <= 0) return '';
  const s = a.strike;
  if (a.option_type === 'PUT' && s > curPrice)
    return '\n  \u{1F449} ç¾åœ¨å€¤ã‚ˆã‚Šé«˜ã„ä¸è‡ªç„¶ãªPUTé…ç½®ã€‚ä¸€æ™‚çš„ãªä¸‹æŠ¼ã—ç…½ã‚Šã®å¯èƒ½æ€§ã‚’ç¤ºå”†';
  if (a.option_type === 'CALL' && s < curPrice)
    return '\n  \u{1F449} ç¾åœ¨å€¤ã‚ˆã‚Šä½ã„ä¸è‡ªç„¶ãªCALLé…ç½®ã€‚ä¸€æ™‚çš„ãªé«˜å€¤æ´ã¿èª˜ç™ºã®å¯èƒ½æ€§ã‚’ç¤ºå”†';
  return '\n  \u{1F449} é€šå¸¸ã®ç‰½åˆ¶ï¼ˆã‘ã‚“ã›ã„ï¼‰ç›®çš„ã®åšã„æ¿';
}

/* ============================================================
   Format alerts (desktop format functions)
   ============================================================ */
function fmtWhale(a) {
  const dir = dirLabel(a.option_type, a.ratio);
  const r = (a.ratio >= 999) ? '\u221E\u500D' : '\u901A\u5E38\u306E' + a.ratio + '\u500D';
  return '\u{1F6A8} \u3010' + a.ticker + '\u3011 ' + dir + ' $' + a.strike + '  Vol:' + a.volume.toLocaleString() + ' (' + r + ')';
}

function fmtSpoof(a, curPrice) {
  const wd = a.wall_side === 'ASK' ? '\u58F2\u58C1' : '\u8CB7\u58C1';
  const wc = wallCommentary(a, curPrice);
  return '\u26A0\uFE0F \u3010' + a.ticker + '\u3011 \u7570\u5E38\u677F(' + a.option_type + ') $' + a.strike + ' ' + wd +
    ' \u677F\u30B5\u30A4\u30BA:' + a.wall_size.toLocaleString() + '\u679A (\u677F\u539A\u6BD4: ' + a.size_ratio + '\u500D) \u203B\u672A\u7D04\u5B9A\u306E\u6307\u5024' + wc;
}

function fmtInsider(a) {
  return '\u{1F575}\uFE0F \u3010' + a.ticker + '\u3011 \u5185\u90E8\u8005\u304C\u81EA\u793E\u682A\u8CFC\u5165! ' +
    a.insider_name + ' (' + a.relationship + ') ' + a.date + ' ' + a.value;
}

/* ============================================================
   Render prediction box (sentiment + judgment)
   ============================================================ */
function renderPredBox(tickers) {
  const box = document.getElementById('predBox');
  let html = '';
  const ts = nowTS();

  // Evaluate previous predictions
  for (const [sym, pred] of Object.entries(predictions)) {
    const info = tickers[sym];
    if (!info || !info.price) continue;
    const curPrice = info.price.price;
    const change = curPrice - pred.price;
    const changeStr = change >= 0 ? '+$' + change.toFixed(2) : '-$' + Math.abs(change).toFixed(2);
    const dirJP = pred.direction === 'up' ? '\u4E0A\u6607' : '\u4E0B\u843D';
    const DRAW_TH = 0.05;

    if (Math.abs(change) <= DRAW_TH) {
      html += logLine(ts, '\u{1F4CA} \u3010\u5224\u5B9A\u3011 \u524D\u56DE(' + pred.time + ')\u306E ' + sym + ' ' + dirJP +
        '\u4E88\u6E2C \u27A1\uFE0F \u{1F504} \u5F15\u304D\u5206\u3051(Draw) (\u682A\u4FA1: $' +
        pred.price.toFixed(2) + ' \u27A1\uFE0F $' + curPrice.toFixed(2) + ' \u3010\u5909\u52D5: ' + changeStr + '\u3011)', 'c-dim');
    } else if ((pred.direction === 'up' && change > DRAW_TH) || (pred.direction === 'down' && change < -DRAW_TH)) {
      html += logLine(ts, '\u{1F4CA} \u3010\u5224\u5B9A\u3011 \u524D\u56DE(' + pred.time + ')\u306E ' + sym + ' ' + dirJP +
        '\u4E88\u6E2C \u27A1\uFE0F \u2705 Hit \u{1F680} (\u682A\u4FA1: $' +
        pred.price.toFixed(2) + ' \u27A1\uFE0F $' + curPrice.toFixed(2) + ' \u3010\u5909\u52D5: ' + changeStr + '\u3011)', 'b-green');
    } else {
      html += logLine(ts, '\u{1F4CA} \u3010\u5224\u5B9A\u3011 \u524D\u56DE(' + pred.time + ')\u306E ' + sym + ' ' + dirJP +
        '\u4E88\u6E2C \u27A1\uFE0F \u274C Miss (\u682A\u4FA1: $' +
        pred.price.toFixed(2) + ' \u27A1\uFE0F $' + curPrice.toFixed(2) + ' \u3010\u5909\u52D5: ' + changeStr + '\u3011)', 'b-red');
    }
  }

  // Current sentiment for tickers with whale alerts
  for (const [sym, info] of Object.entries(tickers)) {
    if (!info.whale_alerts || info.whale_alerts.length === 0) continue;
    const text = info.sentiment_text;
    if (!text) continue;

    let cls = 'b-cyan';
    if (info.sentiment === 'up') cls = 'b-cyan';
    else if (info.sentiment === 'down') cls = 'b-cyan';

    const detected = info.whale_alerts[0].detected_at || ts;
    html += logLine(detected, text, cls);

    // Save prediction for next evaluation
    if (info.sentiment && info.price) {
      predictions[sym] = {
        direction: info.sentiment,
        price: info.price.price,
        time: detected,
      };
    }
  }

  if (!html) {
    html = '<div class="ll c-dim">\u{23F3} \u30BB\u30F3\u30C1\u30E1\u30F3\u30C8\u89E3\u6790\u5F85\u6A5F\u4E2D...</div>';
  }

  const wasAtBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 5;
  box.innerHTML = html;
  if (wasAtBottom) { box.scrollTop = box.scrollHeight; yoyoSnap('predBox'); }
}

/* ============================================================
   Render alert history box
   ============================================================ */
function renderAlertBox(tickers) {
  const box = document.getElementById('alertBox');
  let html = '';

  for (const [sym, info] of Object.entries(tickers)) {
    const curPrice = info.price ? info.price.price : null;

    // Whale alerts
    if (info.whale_alerts) {
      for (const a of info.whale_alerts) {
        const t = a.detected_at || nowTS();
        const text = a.text_jp || fmtWhale(a);
        html += logLine(t, text, 'b-red');
        const adv = adviceText(a);
        if (adv) html += logLine(t, '  ' + adv, 'c-cyan');
      }
    }

    // Spoofing alerts
    if (info.spoofing_alerts) {
      for (const a of info.spoofing_alerts) {
        const t = a.detected_at || nowTS();
        const near = curPrice && curPrice > 0 && a.strike > 0 &&
          Math.abs(a.strike - curPrice) / curPrice <= 0.03;
        const text = a.text_jp || fmtSpoof(a, curPrice);
        html += logLine(t, text, near ? 'b-fire' : 'b-orange');
        const adv = adviceText(a);
        if (adv) html += logLine(t, '  ' + adv, 'c-cyan');
      }
    }

    // Insider alerts
    if (info.insider_alerts) {
      for (const a of info.insider_alerts) {
        const t = a.detected_at || nowTS();
        const text = a.text_jp || fmtInsider(a);
        html += logLine(t, text, 'b-yellow');
        const adv = adviceText(a);
        if (adv) html += logLine(t, '  ' + adv, 'c-cyan');
      }
    }
  }

  if (!html) {
    html = '<div class="ll c-dim">\u{23F3} \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...</div>';
  }

  const wasAtBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 5;
  box.innerHTML = html;
  if (wasAtBottom) { box.scrollTop = box.scrollHeight; yoyoSnap('alertBox'); }
}

/* ============================================================
   Update alert marquee
   ============================================================ */
function updateMarquee(tickers) {
  const items = [];
  for (const [sym, info] of Object.entries(tickers)) {
    if (info.whale_alerts) {
      for (const a of info.whale_alerts) {
        const r = a.ratio >= 999 ? '\u221E\u500D' : a.ratio + '\u500D';
        items.push('\u3010' + a.ticker + '\u3011' + a.option_type + ' $' + a.strike +
          ' Vol:' + a.volume.toLocaleString() + ' (' + r + ')  ' + adviceText(a));
      }
    }
    if (info.spoofing_alerts) {
      for (const a of info.spoofing_alerts) {
        const wd = a.wall_side === 'ASK' ? '\u58F2\u58C1' : '\u8CB7\u3044\u58C1';
        items.push('\u3010' + a.ticker + '\u3011\u7570\u5E38\u677F(' + a.option_type + ') $' +
          a.strike + ' ' + wd + ' (' + a.size_ratio + '\u500D)');
      }
    }
    if (info.insider_alerts) {
      for (const a of info.insider_alerts) {
        items.push('\u3010' + a.ticker + '\u3011\u5185\u90E8\u8005\u8CFC\u5165 ' + a.insider_name);
      }
    }
  }

  const el = document.getElementById('mq2');
  if (items.length > 0) {
    const txt = items.slice(0, 5).join('  |  ');
    el.textContent = txt + '  |  ' + txt;
  } else {
    el.textContent = '\u23F3 \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...    \u23F3 \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...';
  }
}

/* ============================================================
   Gate â€” 1åˆ†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…é ˆ
   ============================================================ */

async function initGate() {
  // sessionStorage ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°æ¤œè¨¼
  const saved = sessionStorage.getItem('wr_token');
  if (saved) {
    try {
      const res = await fetch(API + '/api/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: saved }),
      });
      const data = await res.json();
      if (data.valid) {
        gateUnlocked = true;
        return;  // èªè¨¼æ¸ˆã¿ â†’ ã‚²ãƒ¼ãƒˆä¸è¦
      }
    } catch (_) {}
    sessionStorage.removeItem('wr_token');
  }

  // æœªèªè¨¼ â†’ 1åˆ†å¾Œã«ã‚²ãƒ¼ãƒˆè¡¨ç¤º
  startGateCountdown();
}

function startGateCountdown() {
  let remaining = GATE_DELAY_SEC;
  gateTimer = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(gateTimer);
      showGate();
    }
  }, 1000);
}

function showGate() {
  if (gateUnlocked) return;
  document.getElementById('gateOverlay').classList.add('show');
  document.getElementById('gatePass').focus();
}

async function doGateLogin() {
  const pass = document.getElementById('gatePass').value;
  const errEl = document.getElementById('gateErr');
  errEl.textContent = '';

  if (!pass) {
    errEl.textContent = '\u30D1\u30B9\u30EF\u30FC\u30C9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044';
    return;
  }

  try {
    const res = await fetch(API + '/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pass }),
    });
    const data = await res.json();
    if (data.ok) {
      gateUnlocked = true;
      sessionStorage.setItem('wr_token', data.token);
      document.getElementById('gateOverlay').classList.remove('show');
      if (gateTimer) clearInterval(gateTimer);
    } else {
      errEl.textContent = data.error || '\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u9055\u3044\u307E\u3059';
      document.getElementById('gatePass').value = '';
      document.getElementById('gatePass').focus();
    }
  } catch (e) {
    errEl.textContent = '\u63A5\u7D9A\u30A8\u30E9\u30FC';
  }
}

// Enter ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
document.getElementById('gatePass').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doGateLogin();
});

/* ============================================================
   Main fetch + render
   ============================================================ */
let isScanning = false;

async function poll() {
  try {
    const [ar, sr] = await Promise.all([
      fetch(API + '/api/alerts'),
      fetch(API + '/api/status'),
    ]);
    if (!ar.ok || !sr.ok) throw new Error('HTTP');
    const data = await ar.json();
    const status = await sr.json();
    render(data, status);
  } catch (e) {
    console.error(e);
    const ind = document.getElementById('statusInd');
    ind.textContent = '\u25CF \u63A5\u7D9A\u30A8\u30E9\u30FC';
    ind.className = 'status-ind off';
    document.getElementById('sbLeft').textContent = '  \u26A0 \u63A5\u7D9A\u30A8\u30E9\u30FC  |  \u518D\u63A5\u7D9A\u4E2D...';
  }
}

function render(data, status) {
  /* Build price grid once */
  if (!watchlistBuilt && status.watchlist && status.watchlist.length) {
    buildPrices(status.watchlist);
    watchlistBuilt = true;
  }

  isScanning = data.is_scanning;

  /* Status indicator */
  const ind = document.getElementById('statusInd');
  if (data.is_scanning) {
    ind.textContent = '\u25CF ONLINE \u2500 \u30B9\u30AD\u30E3\u30F3\u4E2D';
    ind.className = 'status-ind on';
  } else if (data.scan_count > 0) {
    ind.textContent = '\u25CF ONLINE';
    ind.className = 'status-ind on';
  } else {
    ind.textContent = '\u25CF OFFLINE';
    ind.className = 'status-ind off';
  }

  /* Progress */
  const pt = document.getElementById('progText');
  const pb = document.getElementById('pbar');
  const pp = document.getElementById('pbarPct');
  if (data.is_scanning) {
    pt.textContent = '\u30B9\u30AD\u30E3\u30F3\u4E2D...';
    pb.style.width = '60%';
    pp.textContent = '\u30B9\u30AD\u30E3\u30F3\u5B9F\u884C\u4E2D';
  } else if (data.scan_count > 0) {
    pt.textContent = '\u30B9\u30AD\u30E3\u30F3 #' + data.scan_count + ' \u5B8C\u4E86';
    pb.style.width = '100%';
    pp.textContent = '100 %';
  } else {
    pt.textContent = '\u5F85\u6A5F\u4E2D...';
    pb.style.width = '0%';
    pp.textContent = '0 %';
  }

  /* Prices */
  if (data.tickers) updatePrices(data.tickers);

  /* Summary */
  const s = data.summary;
  document.getElementById('sWhale').textContent   = s.whale_count;
  document.getElementById('sSpoof').textContent   = s.spoofing_count;
  document.getElementById('sInsider').textContent = s.insider_count;
  document.getElementById('sTotal').textContent   = s.total_alerts;

  totalAlertCount = s.total_alerts;
  document.getElementById('scanCnt').textContent  = data.scan_count;
  document.getElementById('alertCnt').textContent = totalAlertCount;

  /* Prediction box */
  if (data.tickers) renderPredBox(data.tickers);

  /* Alert history box */
  if (data.tickers) renderAlertBox(data.tickers);

  /* Alert marquee */
  if (data.tickers) updateMarquee(data.tickers);

  /* Status bar */
  const last = data.last_scan_at ? new Date(data.last_scan_at).toLocaleTimeString('ja-JP') : '--:--:--';
  const next = data.next_scan_at ? new Date(data.next_scan_at).toLocaleTimeString('ja-JP') : '--:--:--';
  document.getElementById('sbLeft').textContent =
    '  \u6B21\u56DE: ' + next + '  |  Rate-Limit: ON  |  SCANS: ' + data.scan_count;

  lastScanCount = data.scan_count;
}

/* ============================================================
   Timers
   ============================================================ */
setInterval(updateClock, 1000);
updateClock();

setInterval(animatePulse, 80);

setInterval(() => tickSpinner(isScanning), 100);

setInterval(() => { yoyoTick('predBox'); yoyoTick('alertBox'); }, YOYO_INTERVAL);

/* ============================================================
   Init â€” ã‚²ãƒ¼ãƒˆåˆæœŸåŒ– â†’ ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
   ============================================================ */
initGate();
poll();
setInterval(poll, POLL_MS);
</script>
</body>
</html>
