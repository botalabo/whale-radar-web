<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Botalab Whale Radar v4.1 - Anti-Spoofing WEB EDITION</title>
<style>
  /* ============================================
     Cyberpunk Palette ‚Äî whale_radar_gui.py ÂÆåÂÖ®Ê∫ñÊã†
     ============================================ */
  :root {
    --neon-green:  #00FF41;
    --neon-cyan:   #00E5FF;
    --neon-red:    #FF0040;
    --neon-yellow: #FFE600;
    --neon-orange: #FF8800;
    --neon-pink:   #FF2D6A;
    --dark-bg:     #0A0A0F;
    --panel-bg:    #111118;
    --card-bg:     #1A1A25;
    --dim-text:    #556677;
    --white-text:  #E0E0E0;
    --price-up:    #00FF41;
    --price-down:  #FF0040;
    --price-flat:  #888888;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark-bg);
    color: var(--white-text);
    font-family: 'Consolas', 'Courier New', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Grid overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      linear-gradient(rgba(0,229,255,.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,.025) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none; z-index: 0;
  }
  /* Scanlines */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(
      0deg, transparent, transparent 2px,
      rgba(0,0,0,.035) 2px, rgba(0,0,0,.035) 4px);
    pointer-events: none; z-index: 9999;
  }

  /* ============================================ MARQUEE */
  .marquee-row {
    position: relative; z-index: 1;
    height: 36px; overflow: hidden;
    display: flex; align-items: center;
    flex-shrink: 0;
  }
  .marquee-row-1 { background: #000000; }
  .marquee-row-2 { background: #000000; transition: background 0.3s; }

  .marquee-track {
    display: inline-block; white-space: nowrap;
    animation: mq-scroll 45s linear infinite;
    font-family: 'Consolas', monospace;
    font-size: 13px; font-weight: bold;
    padding-left: 100%;
  }
  .marquee-row-1 .marquee-track { color: #FFFF00; }
  .marquee-row-2 .marquee-track { color: #FFA500; animation-duration: 90s; }
  @keyframes mq-scroll {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }

  /* ============================================ HEADER (70px) */
  .header {
    position: relative; z-index: 1;
    display: flex; align-items: center;
    background: var(--panel-bg);
    height: 70px; min-height: 70px;
    padding: 0 15px; flex-shrink: 0;
  }
  .header-title {
    font-size: 22px; font-weight: bold;
    color: var(--neon-green);
    text-shadow: 0 0 20px rgba(0,255,65,.4);
    letter-spacing: 3px; white-space: nowrap;
  }
  .live-label {
    font-size: 14px; font-weight: bold;
    margin-left: 10px; white-space: nowrap;
  }
  .header-sub {
    font-size: 10px; color: var(--dim-text);
    margin-left: 10px; white-space: nowrap;
  }
  .header-right {
    margin-left: auto; display: flex;
    align-items: center; gap: 10px;
  }
  .header-clock {
    font-size: 14px; color: var(--neon-cyan);
    text-shadow: 0 0 8px rgba(0,229,255,.3);
    white-space: nowrap;
  }

  /* BGM toggle */
  .bgm-btn {
    font-family: 'Consolas', monospace;
    font-size: 12px; font-weight: bold;
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px solid;
    transition: all .2s;
    white-space: nowrap;
    user-select: none;
  }
  .bgm-btn.on {
    color: var(--neon-green); background: #002200;
    border-color: var(--neon-green);
    text-shadow: 0 0 6px rgba(0,255,65,.3);
  }
  .bgm-btn.off {
    color: var(--dim-text); background: #1A1A25;
    border-color: #333;
  }
  .bgm-btn:hover { opacity: .85; }

  /* ============================================ TICKER CONFIG OVERLAY */
  .tkcfg-overlay {
    position: fixed; inset: 0; z-index: 8500;
    background: rgba(10,10,15,.92);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .tkcfg-overlay.show { opacity: 1; pointer-events: auto; }

  .tkcfg-box {
    background: var(--panel-bg);
    border: 2px solid var(--neon-cyan);
    border-radius: 12px;
    width: 500px; max-width: 95vw;
    max-height: 85vh;
    display: flex; flex-direction: column;
    box-shadow: 0 0 40px rgba(0,229,255,.15);
    overflow: hidden;
  }
  .tkcfg-header {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #2A2A3A;
  }
  .tkcfg-header h3 {
    font-size: 15px; font-weight: bold;
    color: var(--neon-green);
    margin: 0;
  }
  .tkcfg-close {
    font-size: 18px; color: var(--dim-text);
    cursor: pointer; background: none; border: none;
    font-family: 'Consolas', monospace;
    padding: 2px 8px; border-radius: 4px;
  }
  .tkcfg-close:hover { color: var(--neon-red); }

  /* Add ticker row */
  .tkcfg-add {
    display: flex; gap: 6px;
    padding: 10px 16px;
    border-bottom: 1px solid #2A2A3A;
    background: rgba(0,255,65,.03);
  }
  .tkcfg-add input {
    flex: 1; padding: 8px 12px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 6px;
    color: var(--white-text);
    font-family: 'Consolas', monospace;
    font-size: 14px;
    text-transform: uppercase;
    outline: none;
  }
  .tkcfg-add input:focus {
    border-color: var(--neon-green);
    box-shadow: 0 0 6px rgba(0,255,65,.2);
  }
  .tkcfg-add input::placeholder { color: #444; text-transform: none; }
  .tkcfg-add-btn {
    font-family: 'Consolas', monospace;
    font-size: 13px; font-weight: bold;
    padding: 8px 18px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid var(--neon-green);
    color: var(--neon-green);
    background: #002200;
    white-space: nowrap;
    transition: background .2s;
  }
  .tkcfg-add-btn:hover { background: #003300; }

  .tkcfg-msg {
    font-size: 11px; padding: 4px 16px;
    min-height: 20px;
  }
  .tkcfg-msg.ok { color: var(--neon-green); }
  .tkcfg-msg.err { color: var(--neon-red); }

  /* Ticker list */
  .tkcfg-list {
    flex: 1; min-height: 0;
    overflow-y: auto;
    padding: 6px 12px;
  }
  .tkcfg-list::-webkit-scrollbar { width: 4px; }
  .tkcfg-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .tkcfg-item {
    display: flex; align-items: center;
    padding: 7px 10px;
    background: var(--card-bg);
    border-radius: 6px;
    margin-bottom: 3px;
    transition: background .15s;
  }
  .tkcfg-item:hover { background: rgba(0,229,255,.04); }
  .tkcfg-item-name {
    flex: 1;
    font-size: 14px; font-weight: bold;
    color: var(--neon-green);
  }
  .tkcfg-del {
    font-family: 'Consolas', monospace;
    font-size: 11px; font-weight: bold;
    padding: 3px 12px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px solid var(--neon-red);
    color: var(--neon-red);
    background: transparent;
    transition: all .2s;
    white-space: nowrap;
  }
  .tkcfg-del:hover {
    background: rgba(255,0,64,.15);
    color: #FF4070;
  }

  .tkcfg-count {
    text-align: center; font-size: 10px;
    color: var(--dim-text);
    padding: 6px 0;
    border-top: 1px solid #2A2A3A;
  }
  .tkcfg-count .cy { color: var(--neon-cyan); font-weight: bold; }

  /* Gear button next to price header */
  .price-hdr-wrap {
    display: flex; align-items: center;
    justify-content: center; gap: 6px;
    padding: 4px 10px 2px;
  }
  .gear-btn {
    font-size: 11px; font-weight: bold;
    cursor: pointer;
    color: var(--neon-cyan);
    background: rgba(0,229,255,.08);
    border: 1px solid var(--neon-cyan);
    border-radius: 4px;
    padding: 2px 8px;
    font-family: 'Consolas', monospace;
    transition: all .2s;
    text-shadow: 0 0 6px rgba(0,229,255,.3);
  }
  .gear-btn:hover {
    background: rgba(0,229,255,.18);
    box-shadow: 0 0 8px rgba(0,229,255,.25);
  }

  /* ============================================ MAIN 2-COLUMN */
  .main-area {
    position: relative; z-index: 1;
    display: flex; flex: 1;
    overflow: hidden;
    padding: 5px 10px; gap: 10px;
    min-height: 0;
  }

  /* ============================================ LEFT PANEL (310px) */
  .left-panel {
    width: 310px; min-width: 310px;
    background: var(--panel-bg);
    border: 1px solid #1E1E2E;
    border-radius: 8px;
    display: flex; flex-direction: column;
    overflow: hidden; flex-shrink: 0;
  }

  /* Status indicator */
  .status-ind {
    text-align: center; font-size: 11px;
    font-weight: bold; padding: 8px 0 4px;
  }
  .status-ind.on  { color: var(--neon-green); }
  .status-ind.off { color: var(--dim-text); }

  /* Progress */
  .progress-box {
    margin: 0 10px 4px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px; padding: 4px 8px;
  }
  .progress-row {
    display: flex; align-items: center;
    justify-content: center; gap: 5px;
    font-size: 11px; font-weight: bold;
    color: var(--neon-cyan); padding: 2px 0;
  }
  .progress-row .sp { display: inline-block; width: 16px; text-align: center; }
  .pbar-wrap {
    background: #1A1A25; border-radius: 3px;
    height: 10px; overflow: hidden;
  }
  .pbar-fill {
    height: 100%; background: var(--neon-green);
    border-radius: 3px; width: 0%;
    transition: width 0.6s ease;
  }
  .pbar-pct {
    text-align: center; font-size: 9px;
    color: var(--dim-text); padding: 2px 0;
  }
  .countdown-big {
    text-align: center; padding: 6px 0 2px;
    font-size: 20px; font-weight: bold;
    color: var(--neon-cyan);
    text-shadow: 0 0 12px rgba(0,229,255,.3);
    letter-spacing: 2px;
    font-family: 'Consolas', monospace;
  }

  /* Price header */
  .price-hdr {
    text-align: center; font-size: 10px;
    color: var(--dim-text); padding: 4px 0 2px;
  }

  /* Price grid (scrollable) */
  .price-grid-wrap {
    flex: 1; margin: 0 10px; min-height: 0;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 6px;
    overflow-y: auto; padding: 4px;
  }
  .price-grid-wrap::-webkit-scrollbar { width: 4px; }
  .price-grid-wrap::-webkit-scrollbar-track { background: transparent; }
  .price-grid-wrap::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .price-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
  }
  .price-cell {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 3px 6px; border-radius: 3px;
    background: rgba(0,0,0,.15);
  }
  .price-cell:hover { background: rgba(0,229,255,.04); }
  .price-sym {
    font-size: 11px; font-weight: bold;
    color: var(--neon-green); cursor: pointer;
    transition: text-shadow .2s;
  }
  .price-sym:hover {
    text-shadow: 0 0 8px rgba(0,255,65,.5);
  }
  .price-val {
    font-size: 10px; text-align: right; white-space: nowrap;
    color: var(--dim-text);
  }

  /* Action panel / summary */
  .action-box {
    margin: 4px 10px 6px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px; padding: 5px 8px;
  }
  .action-hdr {
    text-align: center; font-size: 9px;
    color: var(--dim-text); padding: 0 0 3px;
  }
  .sum-row {
    display: flex; justify-content: space-between;
    font-size: 10px; padding: 1px 0;
  }
  .sum-lbl { color: var(--dim-text); }
  .sum-val { font-weight: bold; }
  .sum-val.v-whale   { color: var(--neon-green); }
  .sum-val.v-spoof   { color: var(--neon-yellow); }
  .sum-val.v-insider  { color: var(--neon-pink); }
  .sum-val.v-total   { color: var(--neon-cyan); }

  .scan-info {
    margin: 2px 10px 6px;
    text-align: center; font-size: 9px;
    color: var(--dim-text);
  }
  .scan-info .cy { color: var(--neon-cyan); }

  /* ============================================ RIGHT PANEL */
  .right-panel {
    flex: 1; min-width: 0;
    background: var(--panel-bg);
    border: 1px solid #1E1E2E;
    border-radius: 8px;
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  /* Section wrappers */
  .pred-section {
    flex: 2; display: flex; flex-direction: column;
    padding: 8px 8px 4px; min-height: 0;
  }
  .alert-section {
    flex: 3; display: flex; flex-direction: column;
    padding: 4px 8px 8px; min-height: 0;
  }

  .sec-title {
    font-size: 13px; font-weight: bold;
    padding-bottom: 4px; white-space: nowrap;
    flex-shrink: 0;
  }
  .sec-title.green { color: var(--neon-green); }
  .sec-title.red   { color: var(--neon-red); }
  .date-tag {
    font-size: 10px; font-weight: normal;
    margin-left: 6px; padding: 1px 6px;
    border-radius: 3px; vertical-align: middle;
  }
  .date-tag.prev {
    background: rgba(255,165,0,0.2); color: #FFA500;
    border: 1px solid rgba(255,165,0,0.4);
  }

  /* Log textbox */
  .logbox {
    flex: 1; min-height: 0;
    border-radius: 4px;
    border: 1px solid;
    overflow-y: auto;
    padding: 6px 8px;
    font-size: 14px;
    line-height: 1.55;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .logbox::-webkit-scrollbar { width: 5px; }
  .logbox::-webkit-scrollbar-track { background: transparent; }
  .logbox::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  .logbox.pred {
    background: #080D06; border-color: #1E2E1E;
    color: var(--white-text);
  }
  .logbox.hist {
    background: #0D0006; border-color: #2A0015;
    color: var(--white-text);
  }

  /* Resize handles */
  .resize-h {
    width: 6px; cursor: col-resize;
    background: transparent; flex-shrink: 0;
    position: relative; z-index: 5;
  }
  .resize-h::after {
    content: ''; position: absolute;
    top: 50%; left: 1px; width: 3px; height: 40px;
    transform: translateY(-50%);
    background: #333; border-radius: 2px;
    transition: background .2s;
  }
  .resize-h:hover::after, .resize-h.active::after { background: var(--neon-cyan); }

  .resize-v {
    height: 6px; cursor: row-resize;
    background: transparent; flex-shrink: 0;
    position: relative; z-index: 5;
  }
  .resize-v::after {
    content: ''; position: absolute;
    left: 50%; top: 1px; height: 3px; width: 40px;
    transform: translateX(-50%);
    background: #333; border-radius: 2px;
    transition: background .2s;
  }
  .resize-v:hover::after, .resize-v.active::after { background: var(--neon-cyan); }

  body.resizing-col { cursor: col-resize !important; }
  body.resizing-col * { cursor: col-resize !important; user-select: none !important; }
  body.resizing-row { cursor: row-resize !important; }
  body.resizing-row * { cursor: row-resize !important; user-select: none !important; }

  /* Log lines */
  .ll { padding: 1px 0; border-bottom: 1px solid rgba(255,255,255,.015); }
  .ll .ts { color: var(--dim-text); font-size: 12px; }

  /* Color classes (matching desktop tags) */
  .c-dim    { color: var(--dim-text); }
  .c-green  { color: var(--neon-green); }
  .c-cyan   { color: var(--neon-cyan); }
  .c-red    { color: var(--neon-red); }
  .c-yellow { color: var(--neon-yellow); }
  .c-orange { color: var(--neon-orange); }
  .c-pink   { color: var(--neon-pink); }
  .c-white  { color: var(--white-text); }

  /* Bold variants (desktop: font size 18 bold ‚Üí web: 15px bold) */
  .b-red    { color: var(--neon-red); font-weight: bold; font-size: 15px; }
  .b-green  { color: var(--neon-green); font-weight: bold; font-size: 15px; }
  .b-cyan   { color: var(--neon-cyan); font-weight: bold; font-size: 15px; }
  .b-yellow { color: var(--neon-yellow); font-weight: bold; font-size: 15px; }
  .b-orange { color: var(--neon-orange); font-weight: bold; font-size: 15px; }
  .b-fire   { color: var(--neon-orange); font-weight: bold; font-size: 15px;
              background: #331500; padding: 0 3px; border-radius: 2px; }

  /* Disclaimer */
  .disclaimer {
    flex-shrink: 0; margin-top: 4px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px; padding: 4px 8px;
    font-size: 10px; color: var(--dim-text);
    line-height: 1.4;
  }

  /* ============================================ STATUS BAR (30px) */
  .status-bar {
    position: relative; z-index: 1;
    display: flex; align-items: center;
    justify-content: space-between;
    background: var(--panel-bg);
    height: 30px; min-height: 30px;
    padding: 0 10px; font-size: 11px;
    flex-shrink: 0;
  }
  .sb-left  { color: var(--dim-text); }
  .sb-right { color: #333344; }

  /* ============================================ COPY BUTTONS */
  .sec-header {
    display: flex; align-items: center;
    justify-content: space-between;
    flex-shrink: 0; padding-bottom: 4px;
  }
  .copy-btn {
    font-family: 'Consolas', monospace;
    font-size: 10px; font-weight: bold;
    padding: 2px 10px;
    border-radius: 4px;
    cursor: pointer; border: 1px solid;
    transition: background .2s;
    white-space: nowrap;
  }
  .copy-btn.green {
    color: var(--neon-green); background: #1A1A30;
    border-color: var(--neon-green);
  }
  .copy-btn.green:hover { background: #002200; }
  .copy-btn.cyan {
    color: var(--neon-cyan); background: #1A1A30;
    border-color: var(--neon-cyan);
  }
  .copy-btn.cyan:hover { background: #001A2A; }
  .copy-btn.red {
    color: var(--neon-red); background: #1A1A30;
    border-color: var(--neon-red);
  }
  .copy-btn.red:hover { background: #220000; }
  .copy-btn.active {
    background: var(--neon-cyan) !important;
    color: #000 !important;
    border-color: var(--neon-cyan) !important;
  }
  .copy-btn.flash {
    background: var(--neon-green) !important;
    color: #000 !important;
  }

  /* ============================================ TICKER DETAIL MODAL */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 8000;
    background: rgba(10,10,15,.85);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .modal-overlay.show { opacity: 1; pointer-events: auto; }

  .modal-box {
    background: var(--panel-bg);
    border: 2px solid var(--neon-cyan);
    border-radius: 12px;
    width: 620px; max-width: 95vw;
    max-height: 85vh;
    display: flex; flex-direction: column;
    box-shadow: 0 0 40px rgba(0,229,255,.15);
    overflow: hidden;
  }

  .modal-header {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid #2A2A3A;
  }
  .modal-header-left { display: flex; align-items: baseline; gap: 10px; }
  .modal-ticker {
    font-size: 22px; font-weight: bold; color: var(--neon-green);
    text-shadow: 0 0 12px rgba(0,255,65,.4);
  }
  .modal-price { font-size: 14px; }
  .modal-close {
    font-size: 20px; color: var(--dim-text);
    cursor: pointer; background: none; border: none;
    font-family: 'Consolas', monospace;
    padding: 4px 8px; border-radius: 4px;
  }
  .modal-close:hover { color: var(--neon-red); background: rgba(255,0,64,.1); }

  .modal-summary {
    display: flex; gap: 14px; flex-wrap: wrap;
    padding: 10px 18px;
    background: var(--card-bg);
    border-bottom: 1px solid #2A2A3A;
    font-size: 12px;
  }
  .modal-stat { white-space: nowrap; }

  .modal-tabs {
    display: flex; padding: 0 18px; gap: 4px;
    padding-top: 10px;
  }
  .modal-tab {
    font-family: 'Consolas', monospace;
    font-size: 12px; font-weight: bold;
    padding: 6px 16px; border-radius: 6px 6px 0 0;
    cursor: pointer; border: 1px solid #2A2A3A;
    border-bottom: none; transition: all .2s;
  }
  .modal-tab.active-alert {
    background: var(--neon-green); color: var(--dark-bg);
    border-color: var(--neon-green);
  }
  .modal-tab.inactive {
    background: #1A1A30; color: var(--dim-text);
    border-color: #2A2A3A;
  }
  .modal-tab.inactive:hover { color: var(--neon-cyan); }
  .modal-tab.active-judge {
    background: var(--neon-cyan); color: var(--dark-bg);
    border-color: var(--neon-cyan);
  }

  .modal-content {
    flex: 1; min-height: 0;
    overflow-y: auto;
    padding: 12px 18px 16px;
    font-size: 13px; line-height: 1.6;
  }
  .modal-content::-webkit-scrollbar { width: 5px; }
  .modal-content::-webkit-scrollbar-track { background: transparent; }
  .modal-content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  .modal-content .ml { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,.02); }

  /* ============================================ GATE OVERLAY */
  .gate-overlay {
    position: fixed; inset: 0;
    z-index: 10000;
    background: rgba(10,10,15,.25);
    backdrop-filter: blur(1px);
    -webkit-backdrop-filter: blur(1px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.6s ease;
  }
  .gate-overlay.show {
    opacity: 1; pointer-events: auto;
  }

  .gate-box {
    background: var(--panel-bg);
    border: 2px solid var(--neon-cyan);
    border-radius: 16px;
    padding: 36px 40px;
    width: 480px; max-width: 92vw;
    text-align: center;
    box-shadow: 0 0 60px rgba(0,229,255,.15);
  }
  .gate-box .logo { font-size: 52px; margin-bottom: 8px; }
  .gate-box h2 {
    font-size: 20px; font-weight: bold;
    color: var(--neon-green);
    text-shadow: 0 0 16px rgba(0,255,65,.4);
    letter-spacing: 2px; margin-bottom: 4px;
  }
  .gate-box .edition {
    font-size: 11px; color: var(--dim-text);
    margin-bottom: 20px;
  }

  /* note Ë™òÂ∞é */
  .gate-promo {
    background: #1A1400;
    border: 1px solid rgba(255,230,0,.25);
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 20px;
    text-align: left; line-height: 1.6;
  }
  .gate-promo .promo-title {
    font-size: 14px; font-weight: bold;
    color: var(--neon-yellow);
    margin-bottom: 6px;
  }
  .gate-promo .promo-body {
    font-size: 12px; color: var(--white-text);
  }
  .gate-promo .promo-body .dim { color: var(--dim-text); }
  .gate-promo a {
    color: var(--neon-cyan);
    text-decoration: none;
    font-weight: bold;
  }
  .gate-promo a:hover {
    text-decoration: underline;
    text-shadow: 0 0 8px rgba(0,229,255,.4);
  }
  .gate-promo .member-badge {
    display: inline-block;
    background: rgba(0,255,65,.12);
    border: 1px solid var(--neon-green);
    color: var(--neon-green);
    font-size: 11px; font-weight: bold;
    padding: 2px 10px; border-radius: 4px;
    margin-top: 8px;
  }

  /* countdown */
  .gate-countdown {
    font-size: 11px; color: var(--dim-text);
    margin-bottom: 14px;
  }
  .gate-countdown .sec { color: var(--neon-orange); font-weight: bold; }

  /* input */
  .gate-box input {
    width: 100%; padding: 12px 16px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 6px;
    color: var(--white-text);
    font-family: 'Consolas', monospace;
    font-size: 14px; outline: none;
    margin-bottom: 12px; text-align: center;
  }
  .gate-box input:focus {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 8px rgba(0,229,255,.2);
  }
  .gate-box input::placeholder { color: #444; }
  .gate-box button {
    width: 100%; padding: 12px;
    background: #002200;
    border: 2px solid var(--neon-green);
    border-radius: 6px;
    color: var(--neon-green);
    font-family: 'Consolas', monospace;
    font-size: 15px; font-weight: bold;
    cursor: pointer; transition: background .2s;
  }
  .gate-box button:hover { background: #003300; }
  .gate-error {
    color: var(--neon-red);
    font-size: 12px;
    margin-top: 10px; min-height: 18px;
  }

  /* ============================================ RESPONSIVE ‚Äî Tablet */
  @media (max-width: 900px) {
    .main-area { flex-direction: column; }
    .left-panel { width: 100%; min-width: 100%; max-height: 260px; }
    .price-grid { grid-template-columns: 1fr 1fr 1fr; }
    .header-sub { display: none; }
    .header-title { font-size: 16px; letter-spacing: 1px; }
  }

  /* ============================================ RESPONSIVE ‚Äî Mobile */
  @media (max-width: 600px) {
    body {
      height: auto;
      min-height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Marquee ‚Äî single row, compact */
    .marquee-row { height: 24px; }
    .marquee-track { font-size: 10px; }

    /* Header ‚Äî 1 line compact */
    .header {
      height: 40px; min-height: 40px;
      padding: 0 8px;
    }
    .header-title { font-size: 11px; letter-spacing: 0.5px; }
    .live-label { font-size: 10px; margin-left: 4px; }
    .header-sub { display: none; }
    .header-clock { font-size: 10px; }
    .bgm-btn { font-size: 9px; padding: 2px 6px; }
    .header-right { gap: 5px; }

    /* Main ‚Äî vertical stack */
    .main-area {
      flex-direction: column;
      padding: 3px 4px; gap: 3px;
      flex: none;
      overflow: visible;
    }

    /* ---- LEFT PANEL ‚Äî ultra compact ---- */
    .left-panel {
      width: 100%; min-width: 100%;
      flex-shrink: 0;
      max-height: none;
    }

    /* Status + Progress merged into 1 line */
    .status-ind { font-size: 9px; padding: 3px 0 1px; }
    .progress-box { margin: 0 4px 2px; padding: 2px 6px; }
    .progress-row { font-size: 9px; gap: 3px; }
    .pbar-wrap { height: 4px; }
    .pbar-pct { display: none; }
    .countdown-big { font-size: 16px; padding: 4px 0 1px; }

    /* Price grid ‚Äî 4 columns, enough height to see all tickers */
    .price-hdr { font-size: 8px; padding: 1px 0; }
    .price-hdr-wrap { padding: 2px 4px 1px; gap: 4px; }
    .gear-btn { font-size: 12px; }
    .tkcfg-box { max-width: 100vw; border-radius: 0; max-height: 100vh; }
    .tkcfg-header { padding: 10px 12px; }
    .tkcfg-header h3 { font-size: 13px; }
    .tkcfg-add { padding: 8px 10px; }
    .tkcfg-add input { font-size: 13px; padding: 7px 10px; }
    .tkcfg-add-btn { font-size: 12px; padding: 7px 14px; }
    .tkcfg-list { padding: 4px 8px; }
    .tkcfg-item { padding: 6px 8px; }
    .tkcfg-item-name { font-size: 13px; }
    .tkcfg-del { font-size: 10px; padding: 3px 10px; }
    .price-grid-wrap {
      flex: none;
      max-height: 180px;
      margin: 0 4px;
      padding: 2px;
    }
    .price-grid { grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0; }
    .price-cell { padding: 2px 3px; }
    .price-sym { font-size: 10px; }
    .price-val { font-size: 8px; }

    /* Summary ‚Äî horizontal single line */
    .action-box { margin: 2px 4px 2px; padding: 3px 6px; }
    .action-hdr { display: none; }
    .sum-row { font-size: 8px; padding: 0; }
    .scan-info { display: none; }

    /* ---- RIGHT PANEL ---- */
    .right-panel {
      flex: none;
      min-height: 0;
      overflow: visible;
    }

    .pred-section { padding: 4px 4px 2px; flex: none; }
    .alert-section { padding: 2px 4px 4px; flex: none; }

    /* Section title ‚Äî tappable feel */
    .sec-title { font-size: 10px; }
    .sec-header { padding-bottom: 2px; }

    /* Logbox ‚Äî taller on mobile (40vh each), tappable */
    .logbox {
      flex: none;
      height: 40vh;
      min-height: 160px;
      font-size: 11px;
      line-height: 1.45;
      padding: 4px 5px;
      cursor: pointer;
      position: relative;
    }
    .logbox::after {
      content: '\u25B2 \u30BF\u30C3\u30D7\u3067\u5168\u753B\u9762\u8868\u793A';
      position: absolute;
      bottom: 4px; right: 6px;
      font-size: 8px;
      color: rgba(255,255,255,.25);
      pointer-events: none;
    }

    .b-red, .b-green, .b-cyan, .b-yellow, .b-orange, .b-fire {
      font-size: 12px;
    }
    .ll .ts { font-size: 10px; }

    /* Copy button */
    .copy-btn { font-size: 8px; padding: 2px 5px; }

    /* Disclaimer ‚Äî hide on mobile to save space */
    .disclaimer { display: none; }

    /* Status bar */
    .status-bar {
      height: 24px; min-height: 24px;
      font-size: 8px; padding: 0 6px;
    }
    .sb-right { display: none; }

    /* Gate overlay */
    .gate-box { padding: 20px 16px; }
    .gate-box .logo { font-size: 36px; margin-bottom: 4px; }
    .gate-box h2 { font-size: 15px; letter-spacing: 1px; }
    .gate-box .edition { font-size: 9px; margin-bottom: 12px; }
    .gate-promo { padding: 8px 10px; margin-bottom: 14px; }
    .gate-promo .promo-title { font-size: 11px; }
    .gate-promo .promo-body { font-size: 10px; }
    .gate-box input { font-size: 13px; padding: 10px 12px; }
    .gate-box button { font-size: 13px; padding: 10px; }

    /* Modal ‚Äî full screen on mobile */
    .modal-box {
      width: 100vw; max-width: 100vw;
      max-height: 100vh;
      border-radius: 0;
      border: none;
      border-top: 2px solid var(--neon-cyan);
    }
    .modal-header { padding: 10px 12px; }
    .modal-ticker { font-size: 18px; }
    .modal-price { font-size: 12px; }
    .modal-summary { padding: 6px 12px; font-size: 10px; gap: 6px; }
    .modal-tabs { padding: 6px 12px 0; }
    .modal-tab { font-size: 10px; padding: 5px 10px; }
    .modal-content { padding: 8px 12px 12px; font-size: 11px; line-height: 1.5; }
  }

  /* ============================================ LOGBOX EXPAND OVERLAY (mobile tap) */
  .expand-overlay {
    position: fixed; inset: 0; z-index: 7000;
    background: rgba(10,10,15,.96);
    display: flex; flex-direction: column;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .expand-overlay.show { opacity: 1; pointer-events: auto; }

  .expand-header {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: var(--panel-bg);
    border-bottom: 1px solid #2A2A3A;
    flex-shrink: 0;
  }
  .expand-title {
    font-size: 13px; font-weight: bold;
  }
  .expand-title.green { color: var(--neon-green); }
  .expand-title.red   { color: var(--neon-red); }
  .expand-close {
    font-size: 14px; color: var(--dim-text);
    cursor: pointer; background: none; border: none;
    font-family: 'Consolas', monospace;
    padding: 4px 10px; border-radius: 4px;
  }
  .expand-close:hover { color: var(--neon-red); }

  .expand-body {
    flex: 1; min-height: 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 8px 10px;
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.55;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .expand-body.pred { background: #080D06; color: var(--white-text); }
  .expand-body.hist { background: #0D0006; color: var(--white-text); }
</style>
</head>
<body>

<!-- ======== MARQUEE 1 (Yellow ‚Äî Âõ∫ÂÆö„É°„ÉÉ„Çª„Éº„Ç∏) ======== -->
<div class="marquee-row marquee-row-1">
  <div class="marquee-track" id="mq1">&#x26A0;&#xFE0F; Áï∞Â∏∏Êùø„ÇíÊ§úÁü•‰∏≠ÔºöÂ∑®Â§ß„Å™Â£ÅÔºàÊùøÔºâ„ÅØ„ÇØ„Ç∏„É©„ÅÆÁâΩÂà∂„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂÆâÊòì„Å™È£õ„Å≥„Å§„Åç„Å´Ê≥®ÊÑè„ÄÇ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#x26A0;&#xFE0F; Áï∞Â∏∏Êùø„ÇíÊ§úÁü•‰∏≠ÔºöÂ∑®Â§ß„Å™Â£ÅÔºàÊùøÔºâ„ÅØ„ÇØ„Ç∏„É©„ÅÆÁâΩÂà∂„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂÆâÊòì„Å™È£õ„Å≥„Å§„Åç„Å´Ê≥®ÊÑè„ÄÇ</div>
</div>

<!-- ======== MARQUEE 2 (Orange ‚Äî „Ç¢„É©„Éº„ÉàÈÄüÂ†±) ======== -->
<div class="marquee-row marquee-row-2" id="mqRow2">
  <div class="marquee-track" id="mq2">&#x23F3; „Ç¢„É©„Éº„ÉàÂæÖÊ©ü‰∏≠...</div>
</div>

<!-- ======== GATE OVERLAY (1ÂàÜÂæå„Å´Ë°®Á§∫) ======== -->
<div class="gate-overlay" id="gateOverlay">
  <div class="gate-box">
    <div class="logo">&#x1F40B;</div>
    <h2>BOTALAB WHALE RADAR</h2>
    <div class="edition">Anti-Spoofing WEB EDITION</div>

    <div class="gate-promo">
      <div class="promo-title">&#x1F525; „Éú„Çø„É©„Éú note „É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó</div>
      <div class="promo-body">
        „ÇØ„Ç∏„É©„ÉªÁï∞Â∏∏Êùø„Éª„Ç§„É≥„Çµ„Ç§„ÉÄ„Éº„ÅÆÊ§úÁü•„Éá„Éº„Çø„Çí<br>
        24ÊôÇÈñì„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇ<br>
        Â§ßÂè£„ÅÆÂãïÂêë„ÅÆË©≥Á¥∞Ëß£Ë™¨„ÇÑÈäòÊüÑÂàÜÊûê„ÇÇÈÖç‰ø°‰∏≠„ÄÇ<br><br>
        &#x1F449; <a href="https://note.com/bota_labo_note/n/n12cd6b0d2eb2" target="_blank" rel="noopener">„Éú„Çø„É©„Éú note „ÇíË¶ã„Çã</a><br>
        <span class="dim">„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó‰ºöÂì°„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„Åß„ÅÑ„Å§„Åß„ÇÇÈñ≤Ë¶ßÂèØËÉΩ„Åß„Åô„ÄÇ</span><br>
        <span class="member-badge">&#x2705; „É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó‰ºöÂì° ‚Üí „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ„ÅßÂ∏∏ÊôÇÈñ≤Ë¶ßOK</span>
      </div>
    </div>

    <div class="gate-countdown" id="gateCountdown"></div>

    <input type="password" id="gatePass" placeholder="&#x1F512; „É°„É≥„Éê„ÉºÈôêÂÆö„Éë„Çπ„ÉØ„Éº„Éâ" autocomplete="off">
    <button onclick="doGateLogin()">&#x25B6;&ensp;„É≠„Ç∞„Ç§„É≥</button>
    <div class="gate-error" id="gateErr"></div>
  </div>
</div>

<!-- ======== HEADER ======== -->
<div class="header">
  <span class="header-title">&#x1F40B;&ensp;BOTALAB&ensp;WHALE&ensp;RADAR&ensp;v4.1</span>
  <span class="live-label" id="liveLabel">&#x25CF; LIVE</span>
  <span class="header-sub">WEB EDITION</span>
  <div class="header-right">
    <button class="bgm-btn off" id="alarmBtn" onclick="toggleAlarm()">&#x1F515; ALARM OFF</button>
    <button class="bgm-btn off" id="bgmBtn" onclick="toggleBGM()">&#x1F507; BGM OFF</button>
    <span class="header-clock" id="clock">&#x1F550; ----/--/-- --:--:--</span>
  </div>
</div>

<!-- BGM Audio -->
<audio id="bgmAudio" loop preload="auto">
  <source src="/bgm.mp3" type="audio/mpeg">
</audio>

<!-- ======== MAIN AREA ======== -->
<div class="main-area">

  <!-- ===== LEFT PANEL (310px) ===== -->
  <div class="left-panel">

    <!-- ONLINE / OFFLINE -->
    <div class="status-ind off" id="statusInd">&#x25CF; OFFLINE</div>

    <!-- Progress -->
    <div class="progress-box">
      <div class="progress-row">
        <span class="sp" id="spinner"></span>
        <span id="progText">ÂæÖÊ©ü‰∏≠...</span>
      </div>
      <div class="pbar-wrap"><div class="pbar-fill" id="pbar"></div></div>
      <div class="pbar-pct" id="pbarPct">0 %</div>
      <div class="countdown-big" id="countdownBig" style="display:none;"></div>
    </div>

    <!-- Price header -->
    <div class="price-hdr-wrap">
      <span class="price-hdr" id="priceHdr">‚îÄ‚îÄ LIVE PRICES (0) ‚îÄ‚îÄ</span>
      <button class="gear-btn" onclick="openTickerConfig()">&#x2699; &#x9298;&#x67C4;&#x8A2D;&#x5B9A;</button>
    </div>

    <!-- Price grid -->
    <div class="price-grid-wrap">
      <div class="price-grid" id="priceGrid"></div>
    </div>

    <!-- Summary -->
    <div class="action-box">
      <div class="action-hdr">‚îÄ ALERT SUMMARY ‚îÄ</div>
      <div class="sum-row"><span class="sum-lbl">&#x1F6A8; Â§ßÂè£„Ç™„Éó„Ç∑„Éß„É≥</span><span class="sum-val v-whale" id="sWhale">0</span></div>
      <div class="sum-row"><span class="sum-lbl">&#x26A0;&#xFE0F; Áï∞Â∏∏ÊùøÔºàÂ£ÅÔºâ</span><span class="sum-val v-spoof" id="sSpoof">0</span></div>
      <div class="sum-row"><span class="sum-lbl">&#x1F575;&#xFE0F; „Ç§„É≥„Çµ„Ç§„ÉÄ„Éº</span><span class="sum-val v-insider" id="sInsider">0</span></div>
      <div class="sum-row" style="border-top:1px solid #2A2A3A;margin-top:2px;padding-top:3px;">
        <span class="sum-lbl">ÂêàË®à</span><span class="sum-val v-total" id="sTotal">0</span>
      </div>
    </div>

    <!-- Scan info -->
    <div class="scan-info">
      SCANS: <span class="cy" id="scanCnt">0</span> &nbsp;|&nbsp;
      ALERTS: <span class="cy" id="alertCnt">0</span>
    </div>
  </div>

  <!-- Resize handle: left ‚Üî right -->
  <div class="resize-h" id="resizeH"></div>

  <!-- ===== RIGHT PANEL ===== -->
  <div class="right-panel">

    <!-- ‰∫àÊ∏¨„ÉªÂà§ÂÆöÂ±•Ê≠¥ -->
    <div class="pred-section">
      <div class="sec-header">
        <div class="sec-title green">&ensp;&#x1F3AF;&ensp;„ÇØ„Ç∏„É©„ÅÆ‰∫àÊ∏¨„ÉªÂà§ÂÆöÂ±•Ê≠¥ (PREDICTION RECORD)<span id="predDateTag" class="date-tag"></span></div>
        <span style="display:flex;gap:4px;">
          <button class="copy-btn cyan" id="pausePredBtn" onclick="yoyoTogglePause('predBox','pausePredBtn')" title="&#x30B9;&#x30AF;&#x30ED;&#x30FC;&#x30EB;&#x4E00;&#x6642;&#x505C;&#x6B62;">&#x23F8;</button>
          <button class="copy-btn green" id="copyPredBtn" onclick="copyPrediction()">&#x1F3AF; ÂÆüÁ∏æ„Ç≥„Éî„Éº</button>
          <button class="copy-btn cyan" id="todayPredBtn" onclick="toggleTodayPred()">&#x1F4C5; ÂΩìÊó•„ÅÆ„Åø</button>
          <button class="copy-btn red" onclick="clearPredictions()">&#x1F5D1; ÂÖ®Ê∂àÂéª</button>
        </span>
      </div>
      <div style="padding:4px 10px;font-size:11px;color:#8888AA;line-height:1.5;border-bottom:1px solid #1E1E2E;">
        &#x2139;&#xFE0F; Âà§ÂÆöÊñπÊ≥ï: ÂêÑ„Çπ„Ç≠„É£„É≥„ÅßÊ§úÂá∫„Åï„Çå„Åü„ÇØ„Ç∏„É©„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥ÂèñÂºï(CALL/PUT)„ÅÆÂá∫Êù•È´ò„Å®OTM/ITM‰ΩçÁΩÆÈñ¢‰øÇ„Åã„Çâ‰∏äÊòá„Éª‰∏ãËêΩ„Çí‰∫àÊ∏¨„ÄÇÊ¨°Âõû„Çπ„Ç≠„É£„É≥ÊôÇ„ÅÆÊ†™‰æ°„Å®ÊØîËºÉ„Åó„ÄÅÂ§âÂãïÂπÖ„Åå&#xB1;0.15%‰ª•‰∏ä„Å™„Çâ<span style="color:#4ADE80;">Hit</span>/<span style="color:#F87171;">Miss</span>„ÄÅÊú™Ê∫Ä„Å™„Çâ<span style="color:#888;">Draw</span>„Å®Âà§ÂÆö„ÄÇ
      </div>
      <div class="logbox pred" id="predBox" onclick="openExpand('pred')"></div>
    </div>

    <!-- Resize handle: pred ‚Üî alert -->
    <div class="resize-v" id="resizeV"></div>

    <!-- WHALE ALERT Â±•Ê≠¥ -->
    <div class="alert-section">
      <div class="sec-header">
        <div class="sec-title red">&ensp;&#x1F6A8;&ensp;WHALE ALERT Â±•Ê≠¥<span id="alertDateTag" class="date-tag"></span></div>
        <span style="display:flex;gap:4px;">
          <button class="copy-btn cyan" id="pauseAlertBtn" onclick="yoyoTogglePause('alertBox','pauseAlertBtn')" title="&#x30B9;&#x30AF;&#x30ED;&#x30FC;&#x30EB;&#x4E00;&#x6642;&#x505C;&#x6B62;">&#x23F8;</button>
          <button class="copy-btn cyan" id="copyAlertBtn" onclick="copyAlertHistory()">&#x1F4CB; Â±•Ê≠¥„Ç≥„Éî„Éº</button>
          <button class="copy-btn cyan" id="todayAlertBtn" onclick="toggleTodayAlert()">&#x1F4C5; ÂΩìÊó•„ÅÆ„Åø</button>
          <button class="copy-btn red" onclick="clearHistory()">&#x1F5D1; ÂÖ®Ê∂àÂéª</button>
        </span>
      </div>
      <div class="logbox hist" id="alertBox" onclick="openExpand('alert')"></div>

      <div class="disclaimer">
        &#x26A0;&#xFE0F; Áï∞Â∏∏ÊùøÔºöÂøÖ„Åö„Åó„ÇÇ„Éï„Çß„Ç§„ÇØ„Å®„ÅØÈôê„Çä„Åæ„Åõ„Çì„ÄÇÂ§ßÂè£„ÅÆÂÆüÈúÄ„ÅåÂê´„Åæ„Çå„ÇãÂèØËÉΩÊÄß„ÇÇ„ÅÇ„Çä„ÄÅÊùø„ÅÆÂéö„Åø„ÅÆÂ§âÂåñ„ÇíÁ§∫„ÅôÊåáÊ®ô„Åß„Åô„ÄÇ<br>
        Âà§ÂÆöÂü∫Ê∫ñÔºöÂêÑ‰æ°Ê†ºÂ∏Ø„ÅÆÊ≥®Êñá„Çµ„Ç§„Ç∫„ÇíÈäòÊüÑ„Åî„Å®„ÅÆÂπ≥ÂùáÁöÑ„Å™Êùø„ÅÆÂéö„Åø„Å®ÊØîËºÉ„Åó„ÄÅ10ÂÄç‰ª•‰∏ä„ÅÆÁï∞Â∏∏„Çµ„Ç§„Ç∫„ÇíÊ§úÁü•„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
      </div>
    </div>

  </div>
</div>

<!-- ======== TICKER DETAIL MODAL ======== -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-header-left">
        <span class="modal-ticker" id="modalTicker">---</span>
        <span class="modal-price" id="modalPrice"></span>
      </div>
      <button class="modal-close" onclick="closeModal()">&#x2715;</button>
    </div>
    <div class="modal-summary" id="modalSummary"></div>
    <div class="modal-tabs">
      <div class="modal-tab active-alert" id="tabAlert" onclick="switchTab('alerts')">&#x1F6A8; „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥</div>
      <div class="modal-tab inactive" id="tabJudge" onclick="switchTab('judge')">&#x1F3AF; Âà§ÂÆöÂ±•Ê≠¥</div>
    </div>
    <div class="modal-content" id="modalContent"></div>
  </div>
</div>

<!-- ======== TICKER CONFIG OVERLAY ======== -->
<div class="tkcfg-overlay" id="tkcfgOverlay" onclick="if(event.target===this)closeTickerConfig()">
  <div class="tkcfg-box">
    <div class="tkcfg-header">
      <h3>&#x2699; &#x9298;&#x67C4;&#x306E;&#x8FFD;&#x52A0;&#x30FB;&#x524A;&#x9664;</h3>
      <button class="tkcfg-close" onclick="closeTickerConfig()">&#x2715;</button>
    </div>
    <div class="tkcfg-add">
      <input type="text" id="tkcfgInput" placeholder="&#x2795; &#x30C6;&#x30A3;&#x30C3;&#x30AB;&#x30FC;&#x3092;&#x5165;&#x529B; (&#x4F8B;: AAPL)" maxlength="10" autocomplete="off">
      <button class="tkcfg-add-btn" onclick="addTickerFromInput()">&#x2795; &#x8FFD;&#x52A0;</button>
    </div>
    <div class="tkcfg-msg" id="tkcfgMsg"></div>
    <div class="tkcfg-list" id="tkcfgList"></div>
    <div class="tkcfg-count" id="tkcfgCount"></div>
  </div>
</div>

<!-- ======== EXPAND OVERLAY (mobile tap-to-expand) ======== -->
<div class="expand-overlay" id="expandOverlay">
  <div class="expand-header">
    <span class="expand-title" id="expandTitle"></span>
    <button class="expand-close" onclick="closeExpand()">&#x2715; &#x9589;&#x3058;&#x308B;</button>
  </div>
  <div class="expand-body" id="expandBody"></div>
</div>

<!-- ======== STATUS BAR ======== -->
<div class="status-bar">
  <span class="sb-left" id="sbLeft">&ensp;Ready.&ensp;|&ensp;Rate-Limit: ON</span>
  <span class="sb-right">Botalab Whale Radar v4.1 Anti-Spoofing WEB&ensp;</span>
</div>

<script>
/* ============================================================
   Whale Radar v4.1 ‚Äî WEB EDITION
   Desktop GUI ÂÆåÂÖ®ÂÜçÁèæ
   ============================================================ */
const API = window.location.origin;
const POLL_MS = 8000;   // 8Áßí„Éù„Éº„É™„É≥„Ç∞

/* ---------- Gate (5ÂàÜ„Éó„É¨„Éì„É•„Éº ‚Üí „Éë„Çπ„ÉØ„Éº„Éâ / ÊØéÊó•„É™„Çª„ÉÉ„Éà) ---------- */
let gateUnlocked = false;
const GATE_DELAY_SEC = 300;  // 5ÂàÜÂæå„Å´„Ç≤„Éº„ÉàË°®Á§∫
let gateTimer = null;

/* ---------- Spinner (desktop „Å®Âêå„Åò Braille) ---------- */
const SP = ['\u28CB','\u2819','\u2839','\u2838','\u283C','\u2834','\u2826','\u2827','\u2807','\u280F'];
let spIdx = 0;

/* ---------- LIVE pulse ---------- */
let pulseStep = 0;

/* ---------- Yoyo scroll state ---------- */
const YOYO_INTERVAL = 1000;
const YOYO_PAUSE    = 4.0;
const YOYO_SNAP     = 4.0;
const yoyoState = {};

/* ---------- BGM ---------- */
const bgmAudio = document.getElementById('bgmAudio');
let bgmPlaying = false;
bgmAudio.volume = 0.3;

function initBGM() {
  // localStorage „Åã„ÇâË®≠ÂÆö„ÇíÂæ©ÂÖÉ („Éá„Éê„Ç§„Çπ„Åî„Å®„Å´‰øùÂ≠ò)
  const saved = localStorage.getItem('wr_bgm');
  if (saved === 'on') {
    // „É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅåÂøÖË¶Å„Å™„ÅÆ„Åß„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´ÂÜçÁîüÈñãÂßã
    bgmPlaying = true;
    updateBGMBtn();
    // autoplayÂà∂ÈôêÂõûÈÅø: ÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅßÂÜçÁîü„ÇíË©¶„Åø„Çã
    const tryPlay = () => {
      if (bgmPlaying) {
        bgmAudio.play().catch(() => {});
      }
      document.removeEventListener('click', tryPlay);
      document.removeEventListener('touchstart', tryPlay);
    };
    document.addEventListener('click', tryPlay, { once: true });
    document.addEventListener('touchstart', tryPlay, { once: true });
  }
}

function toggleBGM() {
  bgmPlaying = !bgmPlaying;
  if (bgmPlaying) {
    bgmAudio.play().catch(() => {});
    localStorage.setItem('wr_bgm', 'on');
  } else {
    bgmAudio.pause();
    localStorage.setItem('wr_bgm', 'off');
  }
  updateBGMBtn();
}

function updateBGMBtn() {
  const btn = document.getElementById('bgmBtn');
  if (bgmPlaying) {
    btn.textContent = '\u{1F50A} BGM ON';
    btn.className = 'bgm-btn on';
  } else {
    btn.textContent = '\u{1F507} BGM OFF';
    btn.className = 'bgm-btn off';
  }
}

/* ---------- Alert alarm ---------- */
let alarmEnabled = false;
let prevAlertTotal = -1;  // -1 = Êú™ÂàùÊúüÂåñ
let audioCtx = null;

function initAlarm() {
  const saved = localStorage.getItem('wr_alarm');
  if (saved === 'on') {
    alarmEnabled = true;
    updateAlarmBtn();
  }
}

function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
  return audioCtx;
}

function toggleAlarm() {
  alarmEnabled = !alarmEnabled;
  localStorage.setItem('wr_alarm', alarmEnabled ? 'on' : 'off');
  updateAlarmBtn();
  if (alarmEnabled) {
    // ON „Å´„Åó„Åü„ÇâÁ¢∫Ë™ç„Éì„Éº„Éó„ÇíÈ≥¥„Çâ„Åô (AudioContext „ÇÇÂàùÊúüÂåñ)
    playAlertBeep();
    showSbFeedback('\u{1F514} \u30A2\u30E9\u30FC\u30E0ON \u2014 \u65B0\u898F\u30A2\u30E9\u30FC\u30C8\u691C\u77E5\u6642\u306B\u901A\u77E5\u97F3\u304C\u9E23\u308A\u307E\u3059');
  } else {
    showSbFeedback('\u{1F515} \u30A2\u30E9\u30FC\u30E0OFF');
  }
}

function updateAlarmBtn() {
  const btn = document.getElementById('alarmBtn');
  if (alarmEnabled) {
    btn.textContent = '\u{1F514} ALARM ON';
    btn.className = 'bgm-btn on';
  } else {
    btn.textContent = '\u{1F515} ALARM OFF';
    btn.className = 'bgm-btn off';
  }
}

function playAlertBeep() {
  try {
    const ctx = getAudioCtx();
    const now = ctx.currentTime;

    // Tone 1 ‚Äî C5
    const osc1 = ctx.createOscillator();
    const gain1 = ctx.createGain();
    osc1.type = 'sine';
    osc1.connect(gain1);
    gain1.connect(ctx.destination);
    osc1.frequency.value = 523.25;
    gain1.gain.setValueAtTime(0.12, now);
    gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
    osc1.start(now);
    osc1.stop(now + 0.2);

    // Tone 2 ‚Äî E5
    const osc2 = ctx.createOscillator();
    const gain2 = ctx.createGain();
    osc2.type = 'sine';
    osc2.connect(gain2);
    gain2.connect(ctx.destination);
    osc2.frequency.value = 659.25;
    gain2.gain.setValueAtTime(0.12, now + 0.22);
    gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.45);
    osc2.start(now + 0.22);
    osc2.stop(now + 0.45);
  } catch(e) {}
}

/* ---------- Ticker config (add / remove via server API) ---------- */
let serverWatchlist = [];

function openTickerConfig() {
  renderTickerList();
  document.getElementById('tkcfgMsg').textContent = '';
  document.getElementById('tkcfgMsg').className = 'tkcfg-msg';
  document.getElementById('tkcfgInput').value = '';
  document.getElementById('tkcfgOverlay').classList.add('show');
  document.getElementById('tkcfgInput').focus();
}

function closeTickerConfig() {
  document.getElementById('tkcfgOverlay').classList.remove('show');
}

function renderTickerList() {
  const list = document.getElementById('tkcfgList');
  list.innerHTML = '';
  for (const sym of serverWatchlist) {
    const item = document.createElement('div');
    item.className = 'tkcfg-item';
    item.innerHTML =
      '<span class="tkcfg-item-name">' + sym + '</span>' +
      '<button class="tkcfg-del" data-sym="' + sym + '">\u2715 \u524A\u9664</button>';
    item.querySelector('.tkcfg-del').onclick = function() { removeTicker(sym); };
    list.appendChild(item);
  }
  document.getElementById('tkcfgCount').innerHTML =
    '\u76E3\u8996\u4E2D: <span class="cy">' + serverWatchlist.length + '</span> \u9298\u67C4';
}

async function addTickerFromInput() {
  const input = document.getElementById('tkcfgInput');
  const ticker = input.value.trim().toUpperCase();
  if (!ticker) return;

  const msg = document.getElementById('tkcfgMsg');
  msg.textContent = ticker + ' \u3092\u8FFD\u52A0\u4E2D...';
  msg.className = 'tkcfg-msg';

  try {
    const res = await fetch(API + '/api/watchlist/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticker: ticker }),
    });
    const data = await res.json();
    if (data.ok) {
      serverWatchlist = data.watchlist;
      msg.textContent = '\u2705 ' + ticker + ' \u3092\u8FFD\u52A0\u3057\u307E\u3057\u305F';
      msg.className = 'tkcfg-msg ok';
      input.value = '';
      renderTickerList();
      rebuildPriceGrid();
    } else {
      msg.textContent = '\u26A0 ' + (data.error || '\u8FFD\u52A0\u5931\u6557');
      msg.className = 'tkcfg-msg err';
    }
  } catch (e) {
    msg.textContent = '\u274C \u63A5\u7D9A\u30A8\u30E9\u30FC';
    msg.className = 'tkcfg-msg err';
  }
}

async function removeTicker(sym) {
  const msg = document.getElementById('tkcfgMsg');
  msg.textContent = sym + ' \u3092\u524A\u9664\u4E2D...';
  msg.className = 'tkcfg-msg';

  try {
    const res = await fetch(API + '/api/watchlist/remove', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticker: sym }),
    });
    const data = await res.json();
    if (data.ok) {
      serverWatchlist = data.watchlist;
      msg.textContent = '\u2705 ' + sym + ' \u3092\u524A\u9664\u3057\u307E\u3057\u305F';
      msg.className = 'tkcfg-msg ok';
      renderTickerList();
      rebuildPriceGrid();
    } else {
      msg.textContent = '\u26A0 ' + (data.error || '\u524A\u9664\u5931\u6557');
      msg.className = 'tkcfg-msg err';
    }
  } catch (e) {
    msg.textContent = '\u274C \u63A5\u7D9A\u30A8\u30E9\u30FC';
    msg.className = 'tkcfg-msg err';
  }
}

function rebuildPriceGrid() {
  watchlistBuilt = false;
  buildPrices(serverWatchlist);
  watchlistBuilt = true;
}

// Enter key „ÅßËøΩÂä†
document.getElementById('tkcfgInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') addTickerFromInput();
});

/* ---------- Prediction tracking (client-side) ---------- */
let predictions = {};   // { ticker: { direction, price, time } }
let judgmentHistory = []; // accumulated judgment results: { ts, text, cls, date }
let lastScanCount = -1;
let watchlistBuilt = false;
let filterTodayPred = false;
let filterTodayAlert = false;
let totalAlertCount = 0;

/* ---------- Latest tickers data (for modal) ---------- */
let latestTickers = {};
let currentModalTab = 'alerts';
let currentModalTicker = '';

/* ============================================================
   Clock ‚Äî „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Å®Âêå„Åò üïê YYYY-MM-DD HH:MM:SS ÂΩ¢Âºè
   ============================================================ */
function updateClock() {
  const d = new Date();
  const Y = d.getFullYear();
  const M = String(d.getMonth()+1).padStart(2,'0');
  const D = String(d.getDate()).padStart(2,'0');
  const h = String(d.getHours()).padStart(2,'0');
  const m = String(d.getMinutes()).padStart(2,'0');
  const s = String(d.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `\u{1F550} ${Y}-${M}-${D}  ${h}:${m}:${s}`;
}

/* ============================================================
   LIVE pulse (sin-wave #FF0040 ‚Üî #550018)
   ============================================================ */
function animatePulse() {
  pulseStep++;
  const b = (Math.sin(pulseStep * 0.15) + 1) / 2;
  const r = Math.round(0x55 + (0xFF - 0x55) * b);
  const g = 0;
  const bl = Math.round(0x18 + (0x40 - 0x18) * b);
  const c = '#' + r.toString(16).padStart(2,'0') + '00' + bl.toString(16).padStart(2,'0');
  const el = document.getElementById('liveLabel');
  el.style.color = c;
  el.style.textShadow = `0 0 ${Math.round(10*b)}px ${c}`;
}

/* ============================================================
   Spinner
   ============================================================ */
function tickSpinner(scanning) {
  const el = document.getElementById('spinner');
  if (scanning) {
    spIdx = (spIdx + 1) % SP.length;
    el.textContent = SP[spIdx];
  } else {
    el.textContent = '';
  }
}

/* ============================================================
   Yoyo auto-scroll
   ============================================================ */
function getYoyo(id) {
  if (!yoyoState[id]) yoyoState[id] = { dir: 1, pauseUntil: 0, snapUntil: 0 };
  return yoyoState[id];
}
function yoyoSnap(id) {
  const s = getYoyo(id);
  if (s.userPaused) return;
  s.snapUntil = Date.now() / 1000 + YOYO_SNAP;
  s.dir = -1;
  const el = document.getElementById(id);
  if (el) el.scrollTop = el.scrollHeight;
}
function yoyoTogglePause(id, btnId) {
  const s = getYoyo(id);
  const btn = document.getElementById(btnId);
  if (s.userPaused) {
    s.userPaused = false;
    s.pauseUntil = 0;
    if (btn) { btn.textContent = '\u23F8'; btn.title = '\u30B9\u30AF\u30ED\u30FC\u30EB\u4E00\u6642\u505C\u6B62'; btn.classList.remove('active'); }
  } else {
    s.userPaused = true;
    if (btn) { btn.textContent = '\u25B6'; btn.title = '\u30B9\u30AF\u30ED\u30FC\u30EB\u518D\u958B'; btn.classList.add('active'); }
  }
}
function yoyoTick(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const s = getYoyo(id);
  if (s.userPaused) return;
  const now = Date.now() / 1000;

  if (now < s.snapUntil) { el.scrollTop = el.scrollHeight; return; }
  if (now < s.pauseUntil) return;

  const atTop = el.scrollTop <= 0;
  const atBot = el.scrollTop + el.clientHeight >= el.scrollHeight - 2;

  if (s.dir === 1) {
    if (atBot) { s.pauseUntil = now + YOYO_PAUSE; s.dir = -1; }
    else el.scrollTop += 20;
  } else {
    if (atTop) { s.pauseUntil = now + YOYO_PAUSE; s.dir = 1; }
    else el.scrollTop -= 20;
  }
}

/* ============================================================
   Build price grid
   ============================================================ */
function buildPrices(list) {
  const g = document.getElementById('priceGrid');
  g.innerHTML = '';
  for (const sym of list) {
    const c = document.createElement('div');
    c.className = 'price-cell';
    const nameSpan = document.createElement('span');
    nameSpan.className = 'price-sym';
    nameSpan.textContent = sym;
    nameSpan.onclick = () => openTickerDetail(sym);
    const valSpan = document.createElement('span');
    valSpan.className = 'price-val';
    valSpan.id = 'P_' + sym;
    valSpan.textContent = '---';
    c.appendChild(nameSpan);
    c.appendChild(valSpan);
    g.appendChild(c);
  }
  document.getElementById('priceHdr').textContent = '\u2500\u2500 LIVE PRICES (' + list.length + ') \u2500\u2500';
}

/* ============================================================
   Update price labels
   ============================================================ */
function updatePrices(tickers) {
  for (const [sym, info] of Object.entries(tickers)) {
    const el = document.getElementById('P_' + sym);
    if (!el) continue;
    if (info.price) {
      const p = info.price.price;
      const ch = info.price.change;
      const pct = info.price.change_pct;
      const sign = ch >= 0 ? '+' : '';
      el.style.color = ch > 0 ? 'var(--price-up)' : ch < 0 ? 'var(--price-down)' : 'var(--price-flat)';
      el.textContent = '$' + p.toFixed(2) + ' ' + sign + pct.toFixed(1) + '%';
    } else {
      el.style.color = 'var(--dim-text)';
      el.textContent = '---';
    }
  }
}

/* ============================================================
   HTML escape
   ============================================================ */
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ============================================================
   Log line helpers (match desktop format)
   ============================================================ */
function logLine(ts, text, cls) {
  return '<div class="ll"><span class="ts">[' + esc(ts) + '] </span><span class="' + cls + '">' + esc(text) + '</span></div>';
}

function nowTS() {
  const d = new Date();
  return String(d.getHours()).padStart(2,'0') + ':' +
         String(d.getMinutes()).padStart(2,'0') + ':' +
         String(d.getSeconds()).padStart(2,'0');
}
function todayStr() {
  return new Date().toISOString().split('T')[0];
}

/* ============================================================
   Direction label (desktop _get_direction_label)
   ============================================================ */
function dirLabel(optType, ratio) {
  const extreme = ratio >= 10 || ratio >= 999;
  if (optType === 'CALL') return extreme ? '\u{1F4C8} Âº∑„ÅÑ‰∏äÊñπ„Ç∑„Ç∞„Éä„É´(CALL)' : '\u{1F4C8} ‰∏äÊñπ„Ç∑„Ç∞„Éä„É´(CALL)';
  return extreme ? '\u{1F4C9} Âº∑„ÅÑ‰∏ãÊñπ„Ç∑„Ç∞„Éä„É´(PUT)' : '\u{1F4C9} ‰∏ãÊñπ„Ç∑„Ç∞„Éä„É´(PUT)';
}

/* ============================================================
   Advice text (desktop get_advice_text)
   ============================================================ */
function adviceText(a) {
  if (a.type === 'SPOOFING_WALL') {
    if (a.option_type === 'PUT' || a.wall_side === 'BID')
      return '\u{1F449}„ÄêÊà¶Áï•„Äë‰∏ãÊîØ„Åà„ÄÅ„Åæ„Åü„ÅØÊÄ•ËêΩ„ÇíË™ò„ÅÜÁΩ†„ÄÇÂ£Å„ÅÆ„Éñ„É¨„Ç§„ÇØ„ÉÄ„Ç¶„É≥Ôºà‰∏ãÊäú„ÅëÔºâ„Å´Ë≠¶Êàí„Åó„ÄÅÈÄÜÊåáÂÄ§„ÇíÂæπÂ∫ï„ÄÇ';
    return '\u{1F449}„ÄêÊà¶Áï•„Äë‰∏äÂÄ§„ÇíÊäë„Åà„ÇãÂúßÂäõ„ÄÅ„Åæ„Åü„ÅØË∏è„Åø‰∏ä„Åí„ÅÆÁΩ†„ÄÇÂ£Å„ÅÆÁ™ÅÁ†¥Ôºà‰∏äÊäú„ÅëÔºâÊôÇ„ÅÆÊÄ•È®∞„Å´Ë≠¶Êàí„ÄÇ';
  }
  if (a.type === 'WHALE_OPTIONS') {
    if (a.option_type === 'CALL')
      return '\u{1F449}„ÄêÊà¶Áï•„ÄëÂº∑„ÅÑ‰∏äÊòá„Ç∑„Ç∞„Éä„É´„ÄÇ„ÇØ„Ç∏„É©„ÅÆË≥áÈáëÊµÅÂÖ•„Å´ËøΩÂæìÔºàÈ†ÜÂºµ„ÇäÔºâ„ÇíÊ§úË®é„ÄÇ';
    return '\u{1F449}„ÄêÊà¶Áï•„ÄëÂº∑„ÅÑ‰∏ãËêΩ„Ç∑„Ç∞„Éä„É´„ÄÇ‰∏ãÊäº„ÅóÂúßÂäõ„Å´Ë≠¶Êàí„Åó„ÄÅ„É≠„É≥„Ç∞„Éù„Ç∏„Ç∑„Éß„É≥„ÅÆÂà©Á¢∫„Éª„Éò„ÉÉ„Ç∏„ÇíÊ§úË®é„ÄÇ';
  }
  if (a.type === 'INSIDER_BUY')
    return '\u{1F449}„ÄêÊà¶Áï•„ÄëÂÜÖÈÉ®ËÄÖ„ÅÆËá™Á§æÊ†™Ë≥ºÂÖ•„ÅØ‰∏≠Èï∑Êúü„ÅÆÂº∑Ê∞ó„Çµ„Ç§„É≥„ÄÇÊ±∫ÁÆóÊó•Á®ã„Å®Âêà„Çè„Åõ„Å¶Á¢∫Ë™ç„Çí„ÄÇ';
  return '';
}

/* ============================================================
   Wall commentary (desktop _get_wall_commentary)
   ============================================================ */
function wallCommentary(a, curPrice) {
  if (!curPrice || curPrice <= 0) return '';
  const s = a.strike;
  if (a.option_type === 'PUT' && s > curPrice)
    return '\n  \u{1F449} ÁèæÂú®ÂÄ§„Çà„ÇäÈ´ò„ÅÑ‰∏çËá™ÁÑ∂„Å™PUTÈÖçÁΩÆ„ÄÇ‰∏ÄÊôÇÁöÑ„Å™‰∏ãÊäº„ÅóÁÖΩ„Çä„ÅÆÂèØËÉΩÊÄß„ÇíÁ§∫ÂîÜ';
  if (a.option_type === 'CALL' && s < curPrice)
    return '\n  \u{1F449} ÁèæÂú®ÂÄ§„Çà„Çä‰Ωé„ÅÑ‰∏çËá™ÁÑ∂„Å™CALLÈÖçÁΩÆ„ÄÇ‰∏ÄÊôÇÁöÑ„Å™È´òÂÄ§Êé¥„ÅøË™òÁô∫„ÅÆÂèØËÉΩÊÄß„ÇíÁ§∫ÂîÜ';
  return '\n  \u{1F449} ÈÄöÂ∏∏„ÅÆÁâΩÂà∂Ôºà„Åë„Çì„Åõ„ÅÑÔºâÁõÆÁöÑ„ÅÆÂéö„ÅÑÊùø';
}

/* ============================================================
   Format alerts (desktop format functions)
   ============================================================ */
function fmtWhale(a) {
  const dir = dirLabel(a.option_type, a.ratio);
  const r = (a.ratio >= 999) ? '\u221E\u500D' : '\u901A\u5E38\u306E' + a.ratio + '\u500D';
  return '\u{1F6A8} \u3010' + a.ticker + '\u3011 ' + dir + ' $' + a.strike + '  Vol:' + a.volume.toLocaleString() + ' (' + r + ')';
}

function fmtSpoof(a, curPrice) {
  const wd = a.wall_side === 'ASK' ? '\u58F2\u58C1' : '\u8CB7\u58C1';
  const wc = wallCommentary(a, curPrice);
  return '\u26A0\uFE0F \u3010' + a.ticker + '\u3011 \u7570\u5E38\u677F(' + a.option_type + ') $' + a.strike + ' ' + wd +
    ' \u677F\u30B5\u30A4\u30BA:' + a.wall_size.toLocaleString() + '\u679A (\u677F\u539A\u6BD4: ' + a.size_ratio + '\u500D) \u203B\u672A\u7D04\u5B9A\u306E\u6307\u5024' + wc;
}

function fmtInsider(a) {
  return '\u{1F575}\uFE0F \u3010' + a.ticker + '\u3011 \u5185\u90E8\u8005\u304C\u81EA\u793E\u682A\u8CFC\u5165! ' +
    a.insider_name + ' (' + a.relationship + ') ' + a.date + ' ' + a.value;
}

/* ============================================================
   Render prediction box (sentiment + judgment)
   ============================================================ */
function renderPredBox(tickers, marketOpen, marketStatus, scanTS, scanCount) {
  const box = document.getElementById('predBox');
  let html = '';
  const ts = scanTS || nowTS();

  // Market closed ‚Äî show status note (but still display predictions below)
  if (marketOpen === false) {
    html += '<div class="ll b-yellow" style="text-align:center;padding:4px 0;">' +
      '\u{1F3DB}\uFE0F ' + (marketStatus || 'MARKET CLOSED') + '</div>';
  }

  // Evaluate previous predictions ONLY when new scan data arrives
  // (prevents re-evaluation against same price on every poll)
  const isNewScan = scanCount > lastScanCount && lastScanCount >= 0;
  if (isNewScan) {
    const DRAW_PCT = 0.0015; // 0.15% ‚Äî percentage-based draw threshold
    for (const [sym, pred] of Object.entries(predictions)) {
      const info = tickers[sym];
      if (!info || !info.price) continue;
      const curPrice = info.price.price;
      const change = curPrice - pred.price;
      const changePct = pred.price > 0 ? (change / pred.price) * 100 : 0;
      const changeAbs = change >= 0 ? '+$' + change.toFixed(4) : '-$' + Math.abs(change).toFixed(4);
      const changePctStr = (changePct >= 0 ? '+' : '') + changePct.toFixed(3) + '%';
      const changeStr = changeAbs + ' (' + changePctStr + ')';
      const dirJP = pred.direction === 'up' ? '\u4E0A\u6607' : '\u4E0B\u843D';
      const drawTh = pred.price * DRAW_PCT;

      let cls, text, detail;
      if (Math.abs(change) <= drawTh) {
        cls = 'c-dim';
        text = '\u{1F4CA} \u3010\u5224\u5B9A\u3011 ' + sym + ' ' + dirJP +
          '\u4E88\u6E2C \u27A1\uFE0F \u{1F504} Draw ($' +
          pred.price.toFixed(2) + '\u2192$' + curPrice.toFixed(2) + ' ' + changeStr + ')';
        detail = '\u{1F449} \u5909\u52D5\u5E45' + Math.abs(changePct).toFixed(3) +
          '%\u304C\u5224\u5B9A\u57FA\u6E96(\u00B10.15%)\u672A\u6E80\u306E\u305F\u3081\u5F15\u304D\u5206\u3051\u3002' +
          '\u5B9F\u969B\u306E\u5024\u52D5\u304D: ' + changeAbs;
      } else if ((pred.direction === 'up' && change > drawTh) || (pred.direction === 'down' && change < -drawTh)) {
        cls = 'b-green';
        text = '\u{1F4CA} \u3010\u5224\u5B9A\u3011 ' + sym + ' ' + dirJP +
          '\u4E88\u6E2C \u27A1\uFE0F \u2705 Hit \u{1F680} ($' +
          pred.price.toFixed(2) + '\u2192$' + curPrice.toFixed(2) + ' ' + changeStr + ')';
        detail = '\u{1F449} ' + dirJP + '\u4E88\u6E2C\u7684\u4E2D\u3002\u4E88\u6E2C\u6642\u523B(' + pred.time +
          ')\u304B\u3089' + changePctStr + '\u306E' +
          (change > 0 ? '\u4E0A\u6607' : '\u4E0B\u843D') + '\u3092\u78BA\u8A8D';
      } else {
        cls = 'b-red';
        text = '\u{1F4CA} \u3010\u5224\u5B9A\u3011 ' + sym + ' ' + dirJP +
          '\u4E88\u6E2C \u27A1\uFE0F \u274C Miss ($' +
          pred.price.toFixed(2) + '\u2192$' + curPrice.toFixed(2) + ' ' + changeStr + ')';
        detail = '\u{1F449} ' + dirJP + '\u4E88\u6E2C\u306B\u53CD\u3057\u3066' + changePctStr + '\u306E' +
          (change > 0 ? '\u4E0A\u6607' : '\u4E0B\u843D') + '\u3002' +
          '\u4E88\u6E2C\u6642\u523B: ' + pred.time;
      }
      judgmentHistory.push({ ts, text, cls, detail, date: todayStr() });
    }
    // Clear old predictions ‚Äî new ones are saved below
    predictions = {};
  }

  // Show accumulated judgment history with detail lines
  const today = todayStr();
  for (const j of judgmentHistory) {
    if (filterTodayPred && j.date && j.date !== today) continue;
    html += logLine(j.ts, j.text, j.cls);
    if (j.detail) html += logLine(j.ts, '  ' + j.detail, 'c-cyan');
  }

  // Current sentiment for tickers with whale alerts
  for (const [sym, info] of Object.entries(tickers)) {
    if (!info.whale_alerts || info.whale_alerts.length === 0) continue;
    if (filterTodayPred && info.whale_alerts[0].detected_date && info.whale_alerts[0].detected_date !== today) continue;
    const text = info.sentiment_text;
    if (!text) continue;

    let cls = 'b-cyan';
    const detected = info.whale_alerts[0].detected_at || ts;
    html += logLine(detected, text, cls);

    // Save prediction for next evaluation
    if (info.sentiment && info.price) {
      predictions[sym] = {
        direction: info.sentiment,
        price: info.price.price,
        time: detected,
      };
    }
  }

  // ÂâçÊó•„Éá„Éº„Çø„Åå„ÅÇ„Çã„ÅãÂà§ÂÆö„Åó„Å¶„Çø„Ç∞Ë°®Á§∫
  const predTag = document.getElementById('predDateTag');
  const predDates = new Set();
  for (const j of judgmentHistory) { if (j.date) predDates.add(j.date); }
  for (const info of Object.values(tickers)) {
    if (info.whale_alerts) {
      for (const a of info.whale_alerts) { if (a.detected_date) predDates.add(a.detected_date); }
    }
  }
  const hasPrevPred = [...predDates].some(d => d !== today);
  if (hasPrevPred && !filterTodayPred) {
    predTag.className = 'date-tag prev';
    predTag.textContent = '\u524D\u65E5\u5206\u3092\u542B\u3080';
  } else {
    predTag.className = 'date-tag';
    predTag.textContent = '';
  }

  if (!html) {
    html = '<div class="ll c-dim">\u{23F3} \u30BB\u30F3\u30C1\u30E1\u30F3\u30C8\u89E3\u6790\u5F85\u6A5F\u4E2D...</div>';
  }

  const wasAtBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 5;
  box.innerHTML = html;
  if (wasAtBottom) { box.scrollTop = box.scrollHeight; yoyoSnap('predBox'); }
}

/* ============================================================
   Render alert history box
   ============================================================ */
function renderAlertBox(tickers) {
  const box = document.getElementById('alertBox');
  let html = '';
  const today = todayStr();

  for (const [sym, info] of Object.entries(tickers)) {
    const curPrice = info.price ? info.price.price : null;

    // Whale alerts
    if (info.whale_alerts) {
      for (const a of info.whale_alerts) {
        if (filterTodayAlert && a.detected_date && a.detected_date !== today) continue;
        const t = a.detected_at || nowTS();
        const text = a.text_jp || fmtWhale(a);
        html += logLine(t, text, 'b-red');
        const adv = adviceText(a);
        if (adv) html += logLine(t, '  ' + adv, 'c-cyan');
      }
    }

    // Spoofing alerts
    if (info.spoofing_alerts) {
      for (const a of info.spoofing_alerts) {
        if (filterTodayAlert && a.detected_date && a.detected_date !== today) continue;
        const t = a.detected_at || nowTS();
        const near = curPrice && curPrice > 0 && a.strike > 0 &&
          Math.abs(a.strike - curPrice) / curPrice <= 0.03;
        const text = a.text_jp || fmtSpoof(a, curPrice);
        html += logLine(t, text, near ? 'b-fire' : 'b-orange');
        const adv = adviceText(a);
        if (adv) html += logLine(t, '  ' + adv, 'c-cyan');
      }
    }

    // Insider alerts
    if (info.insider_alerts) {
      for (const a of info.insider_alerts) {
        if (filterTodayAlert && a.detected_date && a.detected_date !== today) continue;
        const t = a.detected_at || nowTS();
        const text = a.text_jp || fmtInsider(a);
        html += logLine(t, text, 'b-yellow');
        const adv = adviceText(a);
        if (adv) html += logLine(t, '  ' + adv, 'c-cyan');
      }
    }
  }

  if (!html) {
    html = '<div class="ll c-dim">\u{23F3} \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...</div>';
  }

  // ÂâçÊó•„Éá„Éº„Çø„Åå„ÅÇ„Çã„ÅãÂà§ÂÆö„Åó„Å¶„Çø„Ç∞Ë°®Á§∫
  const alertTag = document.getElementById('alertDateTag');
  const alertDates = new Set();
  for (const info of Object.values(tickers)) {
    for (const arr of [info.whale_alerts||[], info.spoofing_alerts||[], info.insider_alerts||[]]) {
      for (const a of arr) { if (a.detected_date) alertDates.add(a.detected_date); }
    }
  }
  const hasPrevAlert = [...alertDates].some(d => d !== today);
  if (hasPrevAlert && !filterTodayAlert) {
    alertTag.className = 'date-tag prev';
    alertTag.textContent = '\u524D\u65E5\u5206\u3092\u542B\u3080';
  } else {
    alertTag.className = 'date-tag';
    alertTag.textContent = '';
  }

  const wasAtBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 5;
  box.innerHTML = html;
  if (wasAtBottom) { box.scrollTop = box.scrollHeight; yoyoSnap('alertBox'); }
}

/* ============================================================
   Update alert marquee
   ============================================================ */
function updateMarquee(tickers) {
  const items = [];
  for (const [sym, info] of Object.entries(tickers)) {
    if (info.whale_alerts) {
      for (const a of info.whale_alerts) {
        const r = a.ratio >= 999 ? '\u221E\u500D' : a.ratio + '\u500D';
        items.push('\u3010' + a.ticker + '\u3011' + a.option_type + ' $' + a.strike +
          ' Vol:' + a.volume.toLocaleString() + ' (' + r + ')  ' + adviceText(a));
      }
    }
    if (info.spoofing_alerts) {
      for (const a of info.spoofing_alerts) {
        const wd = a.wall_side === 'ASK' ? '\u58F2\u58C1' : '\u8CB7\u3044\u58C1';
        items.push('\u3010' + a.ticker + '\u3011\u7570\u5E38\u677F(' + a.option_type + ') $' +
          a.strike + ' ' + wd + ' (' + a.size_ratio + '\u500D)');
      }
    }
    if (info.insider_alerts) {
      for (const a of info.insider_alerts) {
        items.push('\u3010' + a.ticker + '\u3011\u5185\u90E8\u8005\u8CFC\u5165 ' + a.insider_name);
      }
    }
  }

  const el = document.getElementById('mq2');
  if (items.length > 0) {
    const txt = items.slice(0, 5).join('  |  ');
    el.textContent = txt + '  |  ' + txt;
  } else {
    el.textContent = '\u23F3 \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...    \u23F3 \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...';
  }
}

/* ============================================================
   Ticker detail modal
   ============================================================ */
function openTickerDetail(sym) {
  currentModalTicker = sym;
  const info = latestTickers[sym];
  if (!info) return;

  // Header: ticker + price
  document.getElementById('modalTicker').textContent = sym;
  const mp = document.getElementById('modalPrice');
  if (info.price) {
    const ch = info.price.change;
    const sign = ch >= 0 ? '+' : '';
    const color = ch > 0 ? 'var(--price-up)' : ch < 0 ? 'var(--price-down)' : 'var(--price-flat)';
    mp.innerHTML = '<span style="color:' + color + '">$' + info.price.price.toFixed(2) +
      ' (' + sign + info.price.change_pct.toFixed(1) + '%)</span>';
  } else {
    mp.innerHTML = '<span style="color:var(--dim-text)">---</span>';
  }

  // Summary counts
  const wa = info.whale_alerts || [];
  const sa = info.spoofing_alerts || [];
  const ia = info.insider_alerts || [];
  const callCnt = wa.filter(a => a.option_type === 'CALL').length;
  const putCnt = wa.filter(a => a.option_type === 'PUT').length;
  const total = wa.length + sa.length + ia.length;

  const sm = document.getElementById('modalSummary');
  sm.innerHTML =
    '<span class="modal-stat" style="color:var(--neon-cyan);font-weight:bold">\u{1F40B} \u30AF\u30B8\u30E9\u691C\u77E5: ' + total + '\u4EF6</span>' +
    '<span class="modal-stat" style="color:' + (wa.length ? 'var(--neon-red)' : 'var(--dim-text)') + '">\u{1F6A8} \u30AA\u30D7\u30B7\u30E7\u30F3: ' + wa.length + '</span>' +
    '<span class="modal-stat" style="color:' + (callCnt ? 'var(--price-up)' : 'var(--dim-text)') + '">CALL: ' + callCnt + '</span>' +
    '<span class="modal-stat" style="color:' + (putCnt ? 'var(--price-down)' : 'var(--dim-text)') + '">PUT: ' + putCnt + '</span>' +
    '<span class="modal-stat" style="color:' + (sa.length ? 'var(--neon-orange)' : 'var(--dim-text)') + '">\u26A0 \u7570\u5E38\u677F: ' + sa.length + '</span>' +
    '<span class="modal-stat" style="color:' + (ia.length ? 'var(--neon-yellow)' : 'var(--dim-text)') + '">\u{1F575} \u30A4\u30F3\u30B5\u30A4\u30C0\u30FC: ' + ia.length + '</span>';

  // Default tab
  switchTab('alerts');
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

function switchTab(tab) {
  currentModalTab = tab;
  const tA = document.getElementById('tabAlert');
  const tJ = document.getElementById('tabJudge');
  if (tab === 'alerts') {
    tA.className = 'modal-tab active-alert';
    tJ.className = 'modal-tab inactive';
    renderModalAlerts();
  } else {
    tA.className = 'modal-tab inactive';
    tJ.className = 'modal-tab active-judge';
    renderModalJudge();
  }
}

function renderModalAlerts() {
  const sym = currentModalTicker;
  const info = latestTickers[sym];
  const box = document.getElementById('modalContent');
  if (!info) { box.innerHTML = '<div class="c-dim">\u30C7\u30FC\u30BF\u306A\u3057</div>'; return; }

  const curPrice = info.price ? info.price.price : null;
  let html = '';

  if (info.whale_alerts) {
    for (const a of info.whale_alerts) {
      const text = a.text_jp || fmtWhale(a);
      html += '<div class="ml b-red">' + esc(text) + '</div>';
      const adv = adviceText(a);
      if (adv) html += '<div class="ml c-cyan">  ' + esc(adv) + '</div>';
    }
  }
  if (info.spoofing_alerts) {
    for (const a of info.spoofing_alerts) {
      const near = curPrice && curPrice > 0 && a.strike > 0 &&
        Math.abs(a.strike - curPrice) / curPrice <= 0.03;
      const text = a.text_jp || fmtSpoof(a, curPrice);
      html += '<div class="ml ' + (near ? 'b-fire' : 'b-orange') + '">' + esc(text) + '</div>';
      const adv = adviceText(a);
      if (adv) html += '<div class="ml c-cyan">  ' + esc(adv) + '</div>';
    }
  }
  if (info.insider_alerts) {
    for (const a of info.insider_alerts) {
      const text = a.text_jp || fmtInsider(a);
      html += '<div class="ml b-yellow">' + esc(text) + '</div>';
      const adv = adviceText(a);
      if (adv) html += '<div class="ml c-cyan">  ' + esc(adv) + '</div>';
    }
  }

  // Sentiment
  if (info.sentiment_text) {
    html += '<div class="ml" style="margin-top:8px;padding-top:6px;border-top:1px solid #2A2A3A"><span class="b-cyan">' + esc(info.sentiment_text) + '</span></div>';
  }

  if (!html) html = '<div class="c-dim">\u307E\u3060\u30A2\u30E9\u30FC\u30C8\u304C\u3042\u308A\u307E\u305B\u3093\u3002</div>';
  box.innerHTML = html;
}

function renderModalJudge() {
  const sym = currentModalTicker;
  const pred = predictions[sym];
  const info = latestTickers[sym];
  const box = document.getElementById('modalContent');
  let html = '';

  if (pred && info && info.price) {
    const curPrice = info.price.price;
    const change = curPrice - pred.price;
    const changePct = pred.price > 0 ? (change / pred.price) * 100 : 0;
    const changeAbs = change >= 0 ? '+$' + change.toFixed(4) : '-$' + Math.abs(change).toFixed(4);
    const changePctStr = (changePct >= 0 ? '+' : '') + changePct.toFixed(3) + '%';
    const dirJP = pred.direction === 'up' ? '\u4E0A\u6607' : '\u4E0B\u843D';
    const drawTh = pred.price * 0.0015; // 0.15%

    let cls, result, detail;
    if (Math.abs(change) <= drawTh) {
      cls = 'c-dim'; result = '\u{1F504} Draw (\u5F15\u304D\u5206\u3051)';
      detail = '\u5909\u52D5\u5E45' + Math.abs(changePct).toFixed(3) + '%\u304C\u5224\u5B9A\u57FA\u6E96(\u00B10.15%)\u672A\u6E80\u306E\u305F\u3081\u5F15\u304D\u5206\u3051';
    } else if ((pred.direction === 'up' && change > drawTh) || (pred.direction === 'down' && change < -drawTh)) {
      cls = 'b-green'; result = '\u2705 Hit \u{1F680}';
      detail = dirJP + '\u4E88\u6E2C\u7684\u4E2D\u3002' + changePctStr + '\u306E' + (change > 0 ? '\u4E0A\u6607' : '\u4E0B\u843D') + '\u3092\u78BA\u8A8D';
    } else {
      cls = 'b-red'; result = '\u274C Miss';
      detail = dirJP + '\u4E88\u6E2C\u306B\u53CD\u3057\u3066' + changePctStr + '\u306E' + (change > 0 ? '\u4E0A\u6607' : '\u4E0B\u843D');
    }

    html += '<div class="ml ' + cls + '">\u{1F4CA} \u3010\u5224\u5B9A\u3011 ' + sym + ' ' + dirJP +
      '\u4E88\u6E2C \u27A1\uFE0F ' + result + '</div>';
    html += '<div class="ml c-white">  \u682A\u4FA1: $' + pred.price.toFixed(2) +
      ' \u2192 $' + curPrice.toFixed(2) + ' \u3010\u5909\u52D5: ' + changeAbs + ' (' + changePctStr + ')\u3011</div>';
    html += '<div class="ml c-cyan">  \u{1F449} ' + esc(detail) + '</div>';
    html += '<div class="ml c-dim">  \u4E88\u6E2C\u6642\u523B: ' + pred.time + '</div>';
  }

  // Current sentiment as new prediction
  if (info && info.sentiment_text && info.whale_alerts && info.whale_alerts.length > 0) {
    html += '<div class="ml" style="margin-top:8px;padding-top:6px;border-top:1px solid #2A2A3A">';
    html += '<span class="b-cyan">\u{1F4CA} \u73FE\u5728\u306E\u30BB\u30F3\u30C1\u30E1\u30F3\u30C8:</span></div>';
    html += '<div class="ml c-white">' + esc(info.sentiment_text) + '</div>';
  }

  if (!html) html = '<div class="c-dim">\u307E\u3060\u5224\u5B9A\u7D50\u679C\u304C\u3042\u308A\u307E\u305B\u3093\u3002</div>';
  box.innerHTML = html;
}

// Escape key closes modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal();
});

/* ============================================================
   Copy buttons
   ============================================================ */
function flashBtn(id, duration) {
  const btn = document.getElementById(id);
  btn.classList.add('flash');
  setTimeout(() => btn.classList.remove('flash'), duration || 400);
}

function requireAuth() {
  if (!gateUnlocked) {
    showSbFeedback('\u{1F512} \u30D1\u30B9\u30EF\u30FC\u30C9\u8A8D\u8A3C\u5F8C\u306B\u5229\u7528\u3067\u304D\u307E\u3059');
    return false;
  }
  return true;
}

function copyPrediction() {
  if (!requireAuth()) return;
  const box = document.getElementById('predBox');
  const text = box.innerText.trim();
  if (!text || text === '\u23F3 \u30BB\u30F3\u30C1\u30E1\u30F3\u30C8\u89E3\u6790\u5F85\u6A5F\u4E2D...') {
    showSbFeedback('\u5C65\u6B74\u304C\u7A7A\u3067\u3059');
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  const clipboard = '\u{1F3AF}\u3010\u5224\u5B9A\u5C65\u6B74 \u5168\u4EF6\u30EC\u30DD\u30FC\u30C8\u3011 (' + today + ')\n\n' + text +
    '\n\n\u203B\u6700\u65B0\u306E\u88CF\u89E3\u8AAC\u306Fnote\u3067\u516C\u958B\u4E2D\uFF01\nhttps://note.com/bota_labo_note/n/n12cd6b0d2eb2';
  navigator.clipboard.writeText(clipboard).then(() => {
    flashBtn('copyPredBtn');
    showSbFeedback('\u2705 \u5B9F\u7E3E\u3092\u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u306B\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F');
  });
}

function copyAlertHistory() {
  if (!requireAuth()) return;
  const box = document.getElementById('alertBox');
  const text = box.innerText.trim();
  if (!text || text === '\u23F3 \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...') {
    showSbFeedback('\u5C65\u6B74\u304C\u7A7A\u3067\u3059');
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  const clipboard = '\u{1F4CA}\u3010\u672C\u65E5\u306E\u30AF\u30B8\u30E9\u691C\u77E5\u5C65\u6B74\u3011 (' + today + ')\n\n' + text +
    '\n\n\u203B\u6700\u65B0\u306E\u88CF\u89E3\u8AAC\u306Fnote\u3067\u516C\u958B\u4E2D\uFF01\nhttps://note.com/bota_labo_note/n/n12cd6b0d2eb2';
  navigator.clipboard.writeText(clipboard).then(() => {
    flashBtn('copyAlertBtn');
    showSbFeedback('\u2705 \u30A2\u30E9\u30FC\u30C8\u5C65\u6B74\u3092\u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u306B\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F');
  });
}

function toggleTodayPred() {
  filterTodayPred = !filterTodayPred;
  document.getElementById('todayPredBtn').classList.toggle('active', filterTodayPred);
}
function toggleTodayAlert() {
  filterTodayAlert = !filterTodayAlert;
  document.getElementById('todayAlertBtn').classList.toggle('active', filterTodayAlert);
}

async function clearPredictions() {
  if (!requireAuth()) return;
  if (!confirm('\u5B9F\u7E3E\u3092\u3059\u3079\u3066\u6D88\u53BB\u3057\u307E\u3059\u304B\uFF1F')) return;
  try {
    await fetch(API + '/api/clear/predictions', { method: 'POST' });
    predictions = {};
    judgmentHistory = [];
    document.getElementById('predBox').innerHTML =
      '<div class="ll c-dim">\u23F3 \u30BB\u30F3\u30C1\u30E1\u30F3\u30C8\u89E3\u6790\u5F85\u6A5F\u4E2D...</div>';
    showSbFeedback('\u2705 \u5B9F\u7E3E\u3092\u6D88\u53BB\u3057\u307E\u3057\u305F');
  } catch (_) {
    showSbFeedback('\u274C \u6D88\u53BB\u306B\u5931\u6557\u3057\u307E\u3057\u305F');
  }
}

async function clearHistory() {
  if (!requireAuth()) return;
  if (!confirm('\u5C65\u6B74\u3092\u3059\u3079\u3066\u6D88\u53BB\u3057\u307E\u3059\u304B\uFF1F')) return;
  try {
    await fetch(API + '/api/clear/history', { method: 'POST' });
    document.getElementById('alertBox').innerHTML =
      '<div class="ll c-dim">\u23F3 \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...</div>';
    showSbFeedback('\u2705 \u5C65\u6B74\u3092\u6D88\u53BB\u3057\u307E\u3057\u305F');
  } catch (_) {
    showSbFeedback('\u274C \u6D88\u53BB\u306B\u5931\u6557\u3057\u307E\u3057\u305F');
  }
}

let sbFeedbackActive = false;
function showSbFeedback(msg) {
  const el = document.getElementById('sbLeft');
  sbFeedbackActive = true;
  el.textContent = '  ' + msg;
  el.style.color = 'var(--neon-green)';
  setTimeout(() => { sbFeedbackActive = false; el.style.color = ''; }, 3000);
}

/* ============================================================
   Expand overlay ‚Äî tap logbox to expand (mobile)
   ============================================================ */
let expandedTarget = null;

function isMobile() { return window.innerWidth <= 600; }

function openExpand(which) {
  if (!isMobile()) return;
  const overlay = document.getElementById('expandOverlay');
  const title = document.getElementById('expandTitle');
  const body = document.getElementById('expandBody');

  if (which === 'pred') {
    title.textContent = '\u{1F3AF} \u30AF\u30B8\u30E9\u306E\u4E88\u6E2C\u30FB\u5224\u5B9A\u5C65\u6B74';
    title.className = 'expand-title green';
    body.className = 'expand-body pred';
    body.innerHTML = document.getElementById('predBox').innerHTML;
  } else {
    title.textContent = '\u{1F6A8} WHALE ALERT \u5C65\u6B74';
    title.className = 'expand-title red';
    body.className = 'expand-body hist';
    body.innerHTML = document.getElementById('alertBox').innerHTML;
  }
  expandedTarget = which;
  overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeExpand() {
  document.getElementById('expandOverlay').classList.remove('show');
  expandedTarget = null;
  document.body.style.overflow = '';
}

function refreshExpand() {
  if (!expandedTarget) return;
  const body = document.getElementById('expandBody');
  const src = expandedTarget === 'pred' ? 'predBox' : 'alertBox';
  body.innerHTML = document.getElementById(src).innerHTML;
}

/* ============================================================
   Gate ‚Äî 1ÂàÜ„Éó„É¨„Éì„É•„Éº ‚Üí „Éë„Çπ„ÉØ„Éº„ÉâÂøÖÈ†à
   ============================================================ */

async function initGate() {
  // localStorage ‚Üí sessionStorage „ÅÆÈ†Ü„Åß„Éà„Éº„ÇØ„É≥„ÇíÊ§úË®º
  const savedLocal = localStorage.getItem('wr_token');
  const savedSession = sessionStorage.getItem('wr_token');
  const saved = savedLocal || savedSession;
  if (saved) {
    try {
      const res = await fetch(API + '/api/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: saved }),
      });
      const data = await res.json();
      if (data.valid) {
        gateUnlocked = true;
        return;  // Ë™çË®ºÊ∏à„Åø ‚Üí „Ç≤„Éº„Éà‰∏çË¶Å
      }
    } catch (_) {}
    localStorage.removeItem('wr_token');
    sessionStorage.removeItem('wr_token');
  }

  // „Çµ„Éº„Éê„Éº„Å´IP„Éô„Éº„Çπ„ÅÆ„Ç≤„Éº„ÉàÁä∂ÊÖã„ÇíÂïè„ÅÑÂêà„Çè„Åõ
  try {
    const res = await fetch(API + '/api/gate');
    const gate = await res.json();
    if (gate.locked) {
      showGate();
    } else {
      startGateCountdown(gate.remaining);
    }
  } catch (_) {
    // „Çµ„Éº„Éê„Éº„Ç®„É©„ÉºÊôÇ„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: 5ÂàÜ„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
    startGateCountdown(GATE_DELAY_SEC);
  }
}

function startGateCountdown(remaining) {
  gateTimer = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(gateTimer);
      showGate();
    }
  }, 1000);
}

function showGate() {
  if (gateUnlocked) return;
  document.getElementById('gateOverlay').classList.add('show');
  document.getElementById('gatePass').focus();
}

async function doGateLogin() {
  const pass = document.getElementById('gatePass').value;
  const errEl = document.getElementById('gateErr');
  errEl.textContent = '';

  if (!pass) {
    errEl.textContent = '\u30D1\u30B9\u30EF\u30FC\u30C9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044';
    return;
  }

  try {
    const res = await fetch(API + '/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pass }),
    });
    const data = await res.json();
    if (data.ok) {
      gateUnlocked = true;
      if (data.lifetime) {
        // Ë≤∑„ÅÑÂàá„Çä ‚Üí localStorage „Å´Ê∞∏Á∂ö‰øùÂ≠ò (ÂÜç„É≠„Ç∞„Ç§„É≥‰∏çË¶Å)
        localStorage.setItem('wr_token', data.token);
      } else {
        sessionStorage.setItem('wr_token', data.token);
      }
      document.getElementById('gateOverlay').classList.remove('show');
      if (gateTimer) clearInterval(gateTimer);
    } else {
      errEl.textContent = data.error || '\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u9055\u3044\u307E\u3059';
      document.getElementById('gatePass').value = '';
      document.getElementById('gatePass').focus();
    }
  } catch (e) {
    errEl.textContent = '\u63A5\u7D9A\u30A8\u30E9\u30FC';
  }
}

// Enter „Ç≠„Éº„Åß„É≠„Ç∞„Ç§„É≥
document.getElementById('gatePass').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doGateLogin();
});

/* ============================================================
   Main fetch + render
   ============================================================ */
let isScanning = false;
let nextScanTime = null;
let scanIntervalSec = 300;
let sbNextStr = '--:--:--';
let sbMktTag = '';
let sbScanCnt = 0;

async function poll() {
  try {
    const [ar, sr] = await Promise.all([
      fetch(API + '/api/alerts'),
      fetch(API + '/api/status'),
    ]);
    if (!ar.ok || !sr.ok) throw new Error('HTTP');
    const data = await ar.json();
    const status = await sr.json();
    render(data, status);
  } catch (e) {
    console.error(e);
    const ind = document.getElementById('statusInd');
    ind.textContent = '\u25CF \u63A5\u7D9A\u30A8\u30E9\u30FC';
    ind.className = 'status-ind off';
    document.getElementById('sbLeft').textContent = '  \u26A0 \u63A5\u7D9A\u30A8\u30E9\u30FC  |  \u518D\u63A5\u7D9A\u4E2D...';
  }
}

function render(data, status) {
  /* Build price grid once (filtered by per-device settings) */
  if (!watchlistBuilt && status.watchlist && status.watchlist.length) {
    serverWatchlist = status.watchlist;
    buildPrices(serverWatchlist);
    watchlistBuilt = true;
  }

  /* Store tickers for modal access */
  if (data.tickers) latestTickers = data.tickers;

  isScanning = data.is_scanning;

  /* Status indicator (with market hours) */
  const ind = document.getElementById('statusInd');
  const mktOpen = status.market_open;
  const mktStatus = status.market_status || '';
  if (data.is_scanning) {
    ind.textContent = '\u25CF ONLINE \u2500 \u30B9\u30AD\u30E3\u30F3\u4E2D';
    ind.className = 'status-ind on';
  } else if (data.scan_count > 0) {
    if (mktOpen === false) {
      ind.textContent = '\u25CF ONLINE \u2500 ' + mktStatus;
      ind.className = 'status-ind on';
    } else {
      ind.textContent = '\u25CF ONLINE';
      ind.className = 'status-ind on';
    }
  } else {
    ind.textContent = '\u25CF OFFLINE';
    ind.className = 'status-ind off';
  }

  /* Countdown globals */
  if (data.next_scan_at) nextScanTime = new Date(data.next_scan_at);
  if (status.scan_interval_sec) scanIntervalSec = status.scan_interval_sec;

  /* Progress ‚Äî show per-ticker progress */
  const pt = document.getElementById('progText');
  const pb = document.getElementById('pbar');
  const pp = document.getElementById('pbarPct');
  const prog = status.scanning_progress || '';
  if (data.is_scanning && prog) {
    // "3/20 (TSLA)" ‚Üí extract numbers for progress bar
    const m = prog.match(/^(\d+)\/(\d+)/);
    const pct = m ? Math.round((parseInt(m[1]) / parseInt(m[2])) * 100) : 50;
    pt.textContent = '\u30B9\u30AD\u30E3\u30F3\u4E2D ' + prog;
    pb.style.width = pct + '%';
    pp.textContent = pct + ' %';
    document.getElementById('countdownBig').style.display = 'none';
  } else if (data.is_scanning) {
    pt.textContent = '\u30B9\u30AD\u30E3\u30F3\u958B\u59CB...';
    pb.style.width = '5%';
    pp.textContent = '';
    document.getElementById('countdownBig').style.display = 'none';
  } else if (data.scan_count > 0) {
    updateCountdown();  // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
  } else {
    pt.textContent = '\u5F85\u6A5F\u4E2D...';
    pb.style.width = '0%';
    pp.textContent = '0 %';
  }

  /* Prices */
  if (data.tickers) updatePrices(data.tickers);

  /* Summary */
  const s = data.summary;
  document.getElementById('sWhale').textContent   = s.whale_count;
  document.getElementById('sSpoof').textContent   = s.spoofing_count;
  document.getElementById('sInsider').textContent = s.insider_count;
  document.getElementById('sTotal').textContent   = s.total_alerts;

  totalAlertCount = s.total_alerts;
  document.getElementById('scanCnt').textContent  = data.scan_count;
  document.getElementById('alertCnt').textContent = totalAlertCount;

  /* Alarm ‚Äî Êñ∞Ë¶è„Ç¢„É©„Éº„ÉàÊ§úÂá∫ÊôÇ„Å´„Éì„Éº„ÉóÈü≥ */
  if (alarmEnabled && prevAlertTotal >= 0 && totalAlertCount > prevAlertTotal) {
    playAlertBeep();
  }
  prevAlertTotal = totalAlertCount;

  /* Scan timestamp for prediction display (use server scan time, not client now) */
  let scanTS = nowTS();
  if (data.last_scan_at) {
    const d = new Date(data.last_scan_at);
    if (!isNaN(d.getTime())) {
      scanTS = String(d.getHours()).padStart(2,'0') + ':' +
               String(d.getMinutes()).padStart(2,'0') + ':' +
               String(d.getSeconds()).padStart(2,'0');
    }
  }

  /* Prediction box */
  if (data.tickers) renderPredBox(data.tickers, mktOpen, mktStatus, scanTS, data.scan_count);

  /* Alert history box */
  if (data.tickers) renderAlertBox(data.tickers);

  /* Refresh expand overlay if open */
  refreshExpand();

  /* Alert marquee */
  if (data.tickers) updateMarquee(data.tickers);

  /* Status bar ‚Äî save for countdown updates */
  sbNextStr = data.next_scan_at ? new Date(data.next_scan_at).toLocaleTimeString('ja-JP') : '--:--:--';
  sbMktTag = mktOpen === false ? '  |  ' + mktStatus : '  |  MARKET OPEN';
  sbScanCnt = data.scan_count;
  updateStatusBar();

  lastScanCount = data.scan_count;
}

/* ============================================================
   Countdown ‚Äî Ê¨°Âõû„Çπ„Ç≠„É£„É≥„Åæ„Åß„ÅÆ„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
   ============================================================ */
function updateCountdown() {
  const cdEl = document.getElementById('countdownBig');
  if (isScanning || !nextScanTime) {
    cdEl.style.display = 'none';
    return;
  }
  const now = new Date();
  const diff = Math.max(0, Math.floor((nextScanTime - now) / 1000));

  const min = Math.floor(diff / 60);
  const sec = diff % 60;
  const countStr = String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0');

  /* Progress area */
  const pt = document.getElementById('progText');
  const pb = document.getElementById('pbar');
  const pp = document.getElementById('pbarPct');

  if (diff > 0) {
    pt.textContent = 'NEXT SCAN';
    const elapsed = scanIntervalSec - diff;
    const pct = Math.min(100, Math.round((elapsed / scanIntervalSec) * 100));
    pb.style.width = pct + '%';
    pp.textContent = '';
    cdEl.textContent = countStr;
    cdEl.style.display = 'block';
  } else {
    pt.textContent = '\u30B9\u30AD\u30E3\u30F3\u6E96\u5099\u4E2D...';
    pb.style.width = '100%';
    pp.textContent = '';
    cdEl.style.display = 'none';
  }

  /* Status bar „ÇÇÊõ¥Êñ∞ */
  updateStatusBar();
}

function updateStatusBar() {
  if (sbFeedbackActive) return;
  let cdStr = '';
  if (nextScanTime && !isScanning) {
    const d = Math.max(0, Math.floor((nextScanTime - new Date()) / 1000));
    const m = Math.floor(d / 60);
    const s = d % 60;
    cdStr = ' (\u6B8B\u308A ' + m + ':' + String(s).padStart(2,'0') + ')';
  }
  document.getElementById('sbLeft').textContent =
    '  \u6B21\u56DE: ' + sbNextStr + cdStr + sbMktTag + '  |  SCANS: ' + sbScanCnt;
}

/* ============================================================
   Timers
   ============================================================ */
setInterval(updateClock, 1000);
updateClock();

setInterval(animatePulse, 80);

setInterval(() => tickSpinner(isScanning), 100);

setInterval(updateCountdown, 1000);

setInterval(() => { yoyoTick('predBox'); yoyoTick('alertBox'); }, YOYO_INTERVAL);

/* ============================================================
   Resize handles ‚Äî „Éë„Éç„É´„ÅÆ„Éâ„É©„ÉÉ„Ç∞„É™„Çµ„Ç§„Ç∫
   ============================================================ */
(function() {
  const LS_KEY = 'wr_panel_sizes';
  function saveSizes(obj) {
    try { localStorage.setItem(LS_KEY, JSON.stringify(obj)); } catch(_) {}
  }
  function loadSizes() {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch(_) { return {}; }
  }

  /* --- Horizontal: left ‚Üî right --- */
  const hHandle = document.getElementById('resizeH');
  const leftPanel = document.querySelector('.left-panel');
  const mainArea = document.querySelector('.main-area');

  hHandle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    hHandle.classList.add('active');
    document.body.classList.add('resizing-col');
    const startX = e.clientX;
    const startW = leftPanel.offsetWidth;

    function onMove(e) {
      const newW = Math.max(200, Math.min(startW + (e.clientX - startX), mainArea.offsetWidth - 300));
      leftPanel.style.width = newW + 'px';
      leftPanel.style.minWidth = newW + 'px';
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      hHandle.classList.remove('active');
      document.body.classList.remove('resizing-col');
      const s = loadSizes(); s.leftW = leftPanel.offsetWidth; saveSizes(s);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  /* --- Vertical: pred ‚Üî alert --- */
  const vHandle = document.getElementById('resizeV');
  const predSec = document.querySelector('.pred-section');
  const alertSec = document.querySelector('.alert-section');
  const rightPanel = document.querySelector('.right-panel');

  vHandle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    vHandle.classList.add('active');
    document.body.classList.add('resizing-row');
    const startY = e.clientY;
    const startPredH = predSec.offsetHeight;
    const startAlertH = alertSec.offsetHeight;
    const totalH = startPredH + startAlertH;

    function onMove(e) {
      const delta = e.clientY - startY;
      const newPredH = Math.max(80, Math.min(startPredH + delta, totalH - 80));
      const newAlertH = totalH - newPredH;
      predSec.style.flex = 'none';
      alertSec.style.flex = 'none';
      predSec.style.height = newPredH + 'px';
      alertSec.style.height = newAlertH + 'px';
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      vHandle.classList.remove('active');
      document.body.classList.remove('resizing-row');
      const s = loadSizes();
      s.predH = predSec.offsetHeight;
      s.alertH = alertSec.offsetHeight;
      saveSizes(s);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  /* --- Restore saved sizes --- */
  const saved = loadSizes();
  if (saved.leftW) {
    leftPanel.style.width = saved.leftW + 'px';
    leftPanel.style.minWidth = saved.leftW + 'px';
  }
  if (saved.predH && saved.alertH) {
    predSec.style.flex = 'none';
    alertSec.style.flex = 'none';
    predSec.style.height = saved.predH + 'px';
    alertSec.style.height = saved.alertH + 'px';
  }
})();

/* ============================================================
   Init ‚Äî BGMÂàùÊúüÂåñ ‚Üí „Ç≤„Éº„ÉàÂàùÊúüÂåñ ‚Üí „Éá„Éº„ÇøÂèñÂæóÈñãÂßã
   ============================================================ */
initBGM();
initAlarm();
initGate();
poll();
setInterval(poll, POLL_MS);
</script>
</body>
</html>
