<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOTALAB WHALE RADAR v4.1</title>
<style>
  /* ============================================
     Cyberpunk Palette — whale_radar_gui.py 準拠
     ============================================ */
  :root {
    --neon-green:  #00FF41;
    --neon-cyan:   #00E5FF;
    --neon-red:    #FF0040;
    --neon-yellow: #FFE600;
    --neon-orange: #FF8800;
    --neon-pink:   #FF2D6A;
    --dark-bg:     #0A0A0F;
    --panel-bg:    #111118;
    --card-bg:     #1A1A25;
    --dim-text:    #556677;
    --white-text:  #E0E0E0;
    --price-up:    #00FF41;
    --price-down:  #FF0040;
    --price-flat:  #556677;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark-bg);
    color: var(--white-text);
    font-family: 'Consolas', 'Courier New', 'SF Mono', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Grid overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      linear-gradient(rgba(0,229,255,.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  /* Scanlines */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg, transparent, transparent 2px,
      rgba(0,0,0,.04) 2px, rgba(0,0,0,.04) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* ============================================ MARQUEE */
  .marquee-row {
    position: relative;
    z-index: 1;
    height: 28px;
    overflow: hidden;
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .marquee-row-1 { background: #0A0A00; }
  .marquee-row-2 { background: #0F0800; }

  .marquee-track {
    display: inline-block;
    white-space: nowrap;
    animation: marquee-scroll 40s linear infinite;
    font-size: 13px;
    font-weight: bold;
    padding-left: 100%;
  }
  .marquee-row-1 .marquee-track { color: var(--neon-yellow); }
  .marquee-row-2 .marquee-track { color: var(--neon-orange); }

  @keyframes marquee-scroll {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }

  /* ============================================ HEADER */
  .header {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    background: var(--panel-bg);
    height: 60px;
    padding: 0 15px;
    flex-shrink: 0;
  }

  .header-title {
    font-size: 20px;
    font-weight: bold;
    color: var(--neon-green);
    text-shadow: 0 0 16px rgba(0,255,65,.4);
    letter-spacing: 3px;
    white-space: nowrap;
  }

  .live-label {
    font-size: 14px;
    font-weight: bold;
    margin-left: 12px;
    white-space: nowrap;
  }

  .header-sub {
    font-size: 10px;
    color: var(--dim-text);
    margin-left: 12px;
    white-space: nowrap;
  }

  .header-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-clock {
    font-size: 14px;
    color: var(--neon-cyan);
    text-shadow: 0 0 8px rgba(0,229,255,.3);
  }

  /* ============================================ MAIN AREA */
  .main-area {
    position: relative;
    z-index: 1;
    display: flex;
    flex: 1;
    overflow: hidden;
    padding: 5px 10px;
    gap: 10px;
  }

  /* ============================================ LEFT PANEL */
  .left-panel {
    width: 310px;
    min-width: 310px;
    background: var(--panel-bg);
    border: 1px solid #1E1E2E;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .status-indicator {
    text-align: center;
    font-size: 11px;
    font-weight: bold;
    padding: 6px 0 2px;
  }
  .status-indicator.online { color: var(--neon-green); }
  .status-indicator.offline { color: var(--dim-text); }

  /* Progress section */
  .progress-section {
    margin: 0 10px 3px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px;
    padding: 4px 8px;
  }

  .progress-ticker {
    display: flex;
    align-items: center;
    gap: 4px;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    color: var(--neon-cyan);
    padding: 2px 0;
  }

  .spinner {
    display: inline-block;
    width: 14px;
    text-align: center;
  }

  .progress-bar-wrap {
    background: #1A1A25;
    border-radius: 3px;
    height: 10px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--neon-green);
    border-radius: 3px;
    width: 0%;
    transition: width 0.5s ease;
  }

  .progress-pct {
    text-align: center;
    font-size: 9px;
    color: var(--dim-text);
    padding: 2px 0;
  }

  /* Price section */
  .price-section-header {
    text-align: center;
    font-size: 10px;
    color: var(--dim-text);
    padding: 4px 0 2px;
  }

  .price-grid-wrap {
    flex: 1;
    margin: 0 10px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 6px;
    overflow-y: auto;
    padding: 4px;
  }

  .price-grid-wrap::-webkit-scrollbar { width: 4px; }
  .price-grid-wrap::-webkit-scrollbar-track { background: transparent; }
  .price-grid-wrap::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .price-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2px;
  }

  .price-cell {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 3px 6px;
    border-radius: 3px;
    background: rgba(0,0,0,.2);
  }
  .price-cell:hover { background: rgba(0,229,255,.05); }

  .price-ticker {
    font-size: 11px;
    font-weight: bold;
    color: var(--neon-green);
    cursor: default;
  }

  .price-value {
    font-size: 10px;
    text-align: right;
    white-space: nowrap;
  }

  /* Summary section */
  .summary-section {
    margin: 4px 10px 6px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px;
    padding: 6px 8px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    padding: 1px 0;
  }

  .summary-label { color: var(--dim-text); }
  .summary-value { font-weight: bold; }
  .summary-value.whale { color: var(--neon-green); }
  .summary-value.spoof { color: var(--neon-yellow); }
  .summary-value.insider { color: var(--neon-pink); }
  .summary-value.total { color: var(--neon-cyan); }

  /* ============================================ RIGHT PANEL */
  .right-panel {
    flex: 1;
    background: var(--panel-bg);
    border: 1px solid #1E1E2E;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Prediction box (top 40%) */
  .prediction-section {
    flex: 2;
    display: flex;
    flex-direction: column;
    padding: 8px 8px 4px;
    min-height: 0;
  }

  .section-title {
    font-size: 13px;
    font-weight: bold;
    padding-bottom: 4px;
    white-space: nowrap;
  }
  .section-title.green { color: var(--neon-green); }
  .section-title.red   { color: var(--neon-red); }

  .log-box {
    flex: 1;
    border-radius: 4px;
    border-width: 1px;
    border-style: solid;
    overflow-y: auto;
    padding: 6px 8px;
    font-size: 13px;
    line-height: 1.6;
    word-wrap: break-word;
    min-height: 0;
  }

  .log-box::-webkit-scrollbar { width: 5px; }
  .log-box::-webkit-scrollbar-track { background: transparent; }
  .log-box::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  .prediction-box {
    background: #080D06;
    border-color: #1E2E1E;
    color: var(--white-text);
  }

  /* Alert history box (bottom 60%) */
  .alert-section {
    flex: 3;
    display: flex;
    flex-direction: column;
    padding: 4px 8px 8px;
    min-height: 0;
  }

  .alert-box {
    background: #0D0006;
    border-color: #2A0015;
    color: var(--white-text);
  }

  /* Disclaimer */
  .disclaimer {
    flex-shrink: 0;
    margin-top: 4px;
    background: var(--card-bg);
    border: 1px solid #2A2A3A;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 10px;
    color: var(--dim-text);
    line-height: 1.4;
  }

  /* Log line colors */
  .log-box .c-green  { color: var(--neon-green); }
  .log-box .c-cyan   { color: var(--neon-cyan); }
  .log-box .c-red    { color: var(--neon-red); }
  .log-box .c-yellow { color: var(--neon-yellow); }
  .log-box .c-orange { color: var(--neon-orange); }
  .log-box .c-pink   { color: var(--neon-pink); }
  .log-box .c-dim    { color: var(--dim-text); }
  .log-box .c-white  { color: var(--white-text); }

  .log-box .b-green  { color: var(--neon-green); font-weight: bold; font-size: 14px; }
  .log-box .b-red    { color: var(--neon-red); font-weight: bold; font-size: 14px; }
  .log-box .b-cyan   { color: var(--neon-cyan); font-weight: bold; font-size: 14px; }
  .log-box .b-yellow { color: var(--neon-yellow); font-weight: bold; font-size: 14px; }
  .log-box .b-orange { color: var(--neon-orange); font-weight: bold; font-size: 14px; background: #331500; padding: 0 2px; border-radius: 2px; }

  .log-line {
    padding: 1px 0;
    border-bottom: 1px solid rgba(255,255,255,.02);
  }

  /* ============================================ STATUS BAR */
  .status-bar {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--panel-bg);
    height: 28px;
    padding: 0 12px;
    font-size: 11px;
    flex-shrink: 0;
  }

  .status-bar-left { color: var(--dim-text); }
  .status-bar-right { color: #333344; }

  /* ============================================ RESPONSIVE */
  @media (max-width: 768px) {
    .main-area {
      flex-direction: column;
    }
    .left-panel {
      width: 100%;
      min-width: 100%;
      max-height: 300px;
    }
    .price-grid {
      grid-template-columns: 1fr 1fr 1fr;
    }
    .header-sub { display: none; }
  }
</style>
</head>
<body>

<!-- ======== MARQUEE ROW 1 (Yellow) ======== -->
<div class="marquee-row marquee-row-1">
  <div class="marquee-track" id="marquee1">
    &#x1F40B; Botalab Whale Radar &#x2500; 米国株オプション・異常板・インサイダー リアルタイム監視システム &#x2500; 大口の動きを可視化して個人投資家をサポート &#x2500; データ: yfinance + finviz &#x2500; Anti-Spoofing STREAM Edition &#x2500;
  </div>
</div>

<!-- ======== MARQUEE ROW 2 (Orange / Alert) ======== -->
<div class="marquee-row marquee-row-2">
  <div class="marquee-track" id="marquee2" style="animation-duration:35s;">
    &#x23F3; アラート待機中...
  </div>
</div>

<!-- ======== HEADER ======== -->
<div class="header">
  <span class="header-title">&#x1F40B; BOTALAB WHALE RADAR v4.1</span>
  <span class="live-label" id="liveLabel">&#x25CF; LIVE</span>
  <span class="header-sub">WEB EDITION</span>
  <div class="header-right">
    <span class="header-clock" id="clock">--:--:--</span>
  </div>
</div>

<!-- ======== MAIN AREA (2-column) ======== -->
<div class="main-area">

  <!-- LEFT PANEL -->
  <div class="left-panel">
    <!-- ONLINE/OFFLINE -->
    <div class="status-indicator offline" id="statusIndicator">&#x25CF; OFFLINE</div>

    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-ticker">
        <span class="spinner" id="spinner"></span>
        <span id="progressText">待機中...</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progressBar"></div>
      </div>
      <div class="progress-pct" id="progressPct">0 %</div>
    </div>

    <!-- Price section header -->
    <div class="price-section-header" id="priceHeader">&#x2500;&#x2500; LIVE PRICES (0) &#x2500;&#x2500;</div>

    <!-- Price grid -->
    <div class="price-grid-wrap">
      <div class="price-grid" id="priceGrid"></div>
    </div>

    <!-- Summary -->
    <div class="summary-section">
      <div class="summary-row">
        <span class="summary-label">&#x1F6A8; 大口オプション</span>
        <span class="summary-value whale" id="sumWhale">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">&#x26A0;&#xFE0F; 異常板（壁）</span>
        <span class="summary-value spoof" id="sumSpoof">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">&#x1F575;&#xFE0F; インサイダー</span>
        <span class="summary-value insider" id="sumInsider">0</span>
      </div>
      <div class="summary-row" style="border-top:1px solid #2A2A3A; margin-top:2px; padding-top:3px;">
        <span class="summary-label">合計アラート</span>
        <span class="summary-value total" id="sumTotal">0</span>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <!-- Prediction / Judgment History -->
    <div class="prediction-section">
      <div class="section-title green">&#x1F3AF; クジラの予測・判定履歴 (SENTIMENT RECORD)</div>
      <div class="log-box prediction-box" id="predictionBox">
        <div class="log-line c-dim">センチメント解析待機中...</div>
      </div>
    </div>

    <!-- Whale Alert History -->
    <div class="alert-section">
      <div class="section-title red">&#x1F6A8; WHALE ALERT 履歴</div>
      <div class="log-box alert-box" id="alertBox">
        <div class="log-line c-dim">アラート待機中...</div>
      </div>
      <div class="disclaimer">
        &#x26A0;&#xFE0F; 異常板：必ずしもフェイクとは限りません。大口の実需が含まれる可能性もあり、板の厚みの変化を示す指標です。<br>
        判定基準：各価格帯の注文サイズを銘柄ごとの平均的な板の厚みと比較し、10倍以上の異常サイズを検知しています。
      </div>
    </div>
  </div>

</div>

<!-- ======== STATUS BAR ======== -->
<div class="status-bar">
  <span class="status-bar-left" id="statusBarLeft">Ready. | スキャン: 0回 | 次回更新: --:--:--</span>
  <span class="status-bar-right">Botalab Whale Radar v4.1 Anti-Spoofing WEB</span>
</div>

<script>
/* ============================================================
   Whale Radar v4.1 — Web Dashboard JS
   ============================================================ */
const API = window.location.origin;
const REFRESH_MS = 10_000;  // 10秒ごとにポーリング

// Spinner frames
const SPINNER_FRAMES = ['\u25D0', '\u25D3', '\u25D1', '\u25D2'];
let spinnerIdx = 0;

// LIVE pulse state
let livePulseStep = 0;

/* ============================================================
   Clock
   ============================================================ */
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;
}

/* ============================================================
   LIVE pulse animation (sin-wave like desktop)
   ============================================================ */
function animateLivePulse() {
  livePulseStep++;
  const brightness = (Math.sin(livePulseStep * 0.15) + 1) / 2;
  // Interpolate between #550018 (dim) and #FF0040 (bright)
  const r = Math.round(0x55 + (0xFF - 0x55) * brightness);
  const g = Math.round(0x00 + (0x00 - 0x00) * brightness);
  const b = Math.round(0x18 + (0x40 - 0x18) * brightness);
  const color = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
  document.getElementById('liveLabel').style.color = color;
  document.getElementById('liveLabel').style.textShadow = `0 0 ${Math.round(8 * brightness)}px ${color}`;
}

/* ============================================================
   Spinner animation
   ============================================================ */
function animateSpinner(isScanning) {
  const el = document.getElementById('spinner');
  if (isScanning) {
    spinnerIdx = (spinnerIdx + 1) % SPINNER_FRAMES.length;
    el.textContent = SPINNER_FRAMES[spinnerIdx];
  } else {
    el.textContent = '';
  }
}

/* ============================================================
   Build price grid
   ============================================================ */
function buildPriceGrid(watchlist) {
  const grid = document.getElementById('priceGrid');
  grid.innerHTML = '';
  for (const sym of watchlist) {
    const cell = document.createElement('div');
    cell.className = 'price-cell';
    cell.innerHTML = `<span class="price-ticker">${sym}</span><span class="price-value" id="price_${sym}" style="color:var(--dim-text)">---</span>`;
    grid.appendChild(cell);
  }
  document.getElementById('priceHeader').textContent = `── LIVE PRICES (${watchlist.length}) ──`;
}

/* ============================================================
   Update price labels
   ============================================================ */
function updatePrices(tickers) {
  for (const [sym, info] of Object.entries(tickers)) {
    const el = document.getElementById('price_' + sym);
    if (!el) continue;
    if (info.price) {
      const p = info.price.price;
      const ch = info.price.change;
      const pct = info.price.change_pct;
      const sign = ch >= 0 ? '+' : '';
      let color;
      if (ch > 0) color = 'var(--price-up)';
      else if (ch < 0) color = 'var(--price-down)';
      else color = 'var(--price-flat)';
      el.style.color = color;
      el.textContent = `$${p.toFixed(2)} ${sign}${pct.toFixed(1)}%`;
    } else {
      el.style.color = 'var(--dim-text)';
      el.textContent = '---';
    }
  }
}

/* ============================================================
   Build sentiment (prediction) log
   ============================================================ */
function renderPredictions(tickers) {
  const box = document.getElementById('predictionBox');
  const lines = [];

  for (const [sym, info] of Object.entries(tickers)) {
    if (!info.sentiment_text) continue;
    const text = info.sentiment_text;
    // Determine color class based on sentiment
    let cls = 'c-white';
    if (info.sentiment === 'bullish') cls = 'b-green';
    else if (info.sentiment === 'bearish') cls = 'b-red';
    else if (info.sentiment === 'neutral') cls = 'c-dim';

    if (info.whale_alerts && info.whale_alerts.length > 0) {
      lines.push(`<div class="log-line ${cls}">${escHtml(text)}</div>`);
    }
  }

  if (lines.length === 0) {
    box.innerHTML = '<div class="log-line c-dim">センチメント解析待機中...</div>';
  } else {
    box.innerHTML = lines.join('');
  }
}

/* ============================================================
   Build alert history log
   ============================================================ */
function renderAlertHistory(tickers, history) {
  const box = document.getElementById('alertBox');
  const lines = [];

  // Iterate tickers for current scan alerts (with text_jp)
  for (const [sym, info] of Object.entries(tickers)) {
    // Whale alerts
    if (info.whale_alerts) {
      for (const a of info.whale_alerts) {
        const text = a.text_jp || formatWhaleAlert(a);
        const cls = a.option_type === 'CALL' ? 'c-cyan' : 'c-orange';
        lines.push({ time: a.detected_at || '', html: `<div class="log-line ${cls}">${escHtml(text)}</div>` });
      }
    }
    // Spoofing alerts
    if (info.spoofing_alerts) {
      for (const a of info.spoofing_alerts) {
        const text = a.text_jp || formatSpoofingAlert(a);
        lines.push({ time: a.detected_at || '', html: `<div class="log-line c-yellow">${escHtml(text)}</div>` });
      }
    }
    // Insider alerts
    if (info.insider_alerts) {
      for (const a of info.insider_alerts) {
        const text = a.text_jp || formatInsiderAlert(a);
        lines.push({ time: a.detected_at || '', html: `<div class="log-line c-pink">${escHtml(text)}</div>` });
      }
    }
  }

  if (lines.length === 0) {
    box.innerHTML = '<div class="log-line c-dim">アラート待機中...</div>';
  } else {
    box.innerHTML = lines.map(l => l.html).join('');
  }
}

/* ============================================================
   Update alert marquee
   ============================================================ */
function updateAlertMarquee(tickers) {
  const items = [];
  for (const [sym, info] of Object.entries(tickers)) {
    if (info.whale_alerts) {
      for (const a of info.whale_alerts) {
        const dir = a.option_type === 'CALL' ? '\u{1F4C8}' : '\u{1F4C9}';
        items.push(`\u{1F40B} ${a.ticker} ${dir} $${a.strike} vol:${a.volume.toLocaleString()}`);
      }
    }
    if (info.spoofing_alerts) {
      for (const a of info.spoofing_alerts) {
        const side = a.wall_side === 'ASK' ? '\u58F2\u308A\u58C1' : '\u8CB7\u3044\u58C1';
        items.push(`\u26A0 ${a.ticker} ${side} $${a.strike} ${a.wall_size.toLocaleString()}\u679A`);
      }
    }
    if (info.insider_alerts) {
      for (const a of info.insider_alerts) {
        items.push(`\u{1F575} ${a.ticker} ${a.insider_name} ${a.value}`);
      }
    }
  }

  const el = document.getElementById('marquee2');
  if (items.length > 0) {
    el.textContent = items.join('  |  ') + '  |  ';
  } else {
    el.textContent = '\u23F3 \u30A2\u30E9\u30FC\u30C8\u5F85\u6A5F\u4E2D...';
  }
}

/* ============================================================
   Fallback formatters
   ============================================================ */
function formatWhaleAlert(a) {
  const dir = a.option_type === 'CALL' ? '\u{1F4C8}\u4E0A\u6607' : '\u{1F4C9}\u4E0B\u843D';
  const r = (a.ratio === null || a.ratio >= 999) ? '\u221E\u500D(\u65B0\u898F)' : a.ratio + '\u500D';
  return `\u{1F40B} ${a.ticker} | ${a.option_type} $${a.strike} | ${dir} | vol:${a.volume.toLocaleString()} (${r}) | ${a.expiry}`;
}

function formatSpoofingAlert(a) {
  const side = a.wall_side === 'ASK' ? '\u58F2\u308A\u58C1' : '\u8CB7\u3044\u58C1';
  return `\u26A0 ${a.ticker} | ${side} $${a.strike} | ${a.wall_size.toLocaleString()}\u679A (${a.size_ratio}\u500D) | ${a.option_type} ${a.expiry}`;
}

function formatInsiderAlert(a) {
  return `\u{1F575} ${a.ticker} | ${a.insider_name} (${a.relationship}) | ${a.transaction} ${a.value} | ${a.date}`;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ============================================================
   Main fetch + render
   ============================================================ */
let watchlistBuilt = false;
let prevScanCount = -1;

async function load() {
  try {
    const [alertsRes, statusRes] = await Promise.all([
      fetch(API + '/api/alerts'),
      fetch(API + '/api/status'),
    ]);
    if (!alertsRes.ok || !statusRes.ok) throw new Error('HTTP error');
    const data = await alertsRes.json();
    const status = await statusRes.json();
    render(data, status);
  } catch (e) {
    console.error(e);
    const ind = document.getElementById('statusIndicator');
    ind.textContent = '\u25CF \u63A5\u7D9A\u30A8\u30E9\u30FC';
    ind.className = 'status-indicator offline';
  }
}

function render(data, status) {
  // Build price grid once
  if (!watchlistBuilt && status.watchlist && status.watchlist.length) {
    buildPriceGrid(status.watchlist);
    watchlistBuilt = true;
  }

  // Status indicator
  const ind = document.getElementById('statusIndicator');
  if (data.is_scanning) {
    ind.textContent = '\u25CF SCANNING...';
    ind.className = 'status-indicator online';
  } else if (data.scan_count > 0) {
    ind.textContent = '\u25CF ONLINE';
    ind.className = 'status-indicator online';
  } else {
    ind.textContent = '\u25CF OFFLINE';
    ind.className = 'status-indicator offline';
  }

  // Progress
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');
  const progressPct = document.getElementById('progressPct');

  if (data.is_scanning) {
    progressText.textContent = '\u30B9\u30AD\u30E3\u30F3\u4E2D...';
    // Animate a fake progress based on time
    progressBar.style.width = '60%';
    progressPct.textContent = '\u30B9\u30AD\u30E3\u30F3\u5B9F\u884C\u4E2D';
  } else if (data.scan_count > 0) {
    progressText.textContent = `\u30B9\u30AD\u30E3\u30F3 #${data.scan_count} \u5B8C\u4E86`;
    progressBar.style.width = '100%';
    progressPct.textContent = '100 %';
  } else {
    progressText.textContent = '\u5F85\u6A5F\u4E2D...';
    progressBar.style.width = '0%';
    progressPct.textContent = '0 %';
  }

  // Prices
  if (data.tickers) {
    updatePrices(data.tickers);
  }

  // Summary
  const s = data.summary;
  document.getElementById('sumWhale').textContent = s.whale_count;
  document.getElementById('sumSpoof').textContent = s.spoofing_count;
  document.getElementById('sumInsider').textContent = s.insider_count;
  document.getElementById('sumTotal').textContent = s.total_alerts;

  // Prediction box (sentiment)
  if (data.tickers) {
    renderPredictions(data.tickers);
  }

  // Alert history box
  if (data.tickers) {
    renderAlertHistory(data.tickers, data.history);
  }

  // Alert marquee
  if (data.tickers) {
    updateAlertMarquee(data.tickers);
  }

  // Status bar
  const lastScan = data.last_scan_at ? new Date(data.last_scan_at).toLocaleTimeString('ja-JP') : '--:--:--';
  const nextScan = data.next_scan_at ? new Date(data.next_scan_at).toLocaleTimeString('ja-JP') : '--:--:--';
  document.getElementById('statusBarLeft').textContent =
    `Ready. | \u30B9\u30AD\u30E3\u30F3: ${data.scan_count}\u56DE | \u6700\u7D42: ${lastScan} | \u6B21\u56DE: ${nextScan}`;

  prevScanCount = data.scan_count;
}

/* ============================================================
   Timers
   ============================================================ */
// Clock: every second
setInterval(updateClock, 1000);
updateClock();

// LIVE pulse: every 80ms (like desktop)
setInterval(animateLivePulse, 80);

// Spinner: every 200ms
let isCurrentlyScanning = false;
setInterval(() => animateSpinner(isCurrentlyScanning), 200);

// Polling: every 10 seconds
load();
setInterval(load, REFRESH_MS);

// Track scanning state for spinner
setInterval(async () => {
  try {
    const res = await fetch(API + '/api/status');
    if (res.ok) {
      const st = await res.json();
      isCurrentlyScanning = st.is_scanning || false;
    }
  } catch (_) {}
}, 3000);
</script>
</body>
</html>
